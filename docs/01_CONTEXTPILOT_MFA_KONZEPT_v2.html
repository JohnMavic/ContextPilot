<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CONTEXTPILOT MFA Konzept v2.5</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #1a1a1a;
    }
    
    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    .sidebar {
      width: 320px;
      min-width: 200px;
      max-width: 500px;
      background: #f8f9fa;
      border-right: 2px solid #0078d4;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .sidebar-header {
      padding: 20px;
      background: linear-gradient(135deg, #0078d4, #00a4ef);
      color: white;
      font-weight: 700;
      font-size: 1.1em;
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    
    .sidebar-content ul { list-style: none; padding-left: 0; }
    .sidebar-content ul ul { padding-left: 1.2em; margin-top: 5px; border-left: 1px solid #ddd; }
    .sidebar-content li { margin-bottom: 4px; }
    .sidebar-content a {
      display: block;
      padding: 6px 10px;
      color: #333;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.9em;
      transition: all 0.15s;
    }
    .sidebar-content a:hover {
      background: #e3f2fd;
      color: #0078d4;
      transform: translateX(3px);
    }
    .sidebar-content > ul > li > a { font-weight: 600; color: #0078d4; }
    
    .resizer {
      width: 6px;
      background: #e0e0e0;
      cursor: col-resize;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .resizer:hover, .resizer.active { background: #0078d4; }
    
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 30px 50px;
    }
    
    .content-inner { max-width: 950px; }
    
    h1 { font-size: 1.9em; color: #0078d4; border-bottom: 3px solid #0078d4; padding-bottom: 12px; margin: 1.5em 0 0.8em 0; }
    h2 { font-size: 1.5em; color: #333; margin-top: 2em; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; }
    h3 { font-size: 1.2em; color: #444; margin-top: 1.5em; }
    h4 { font-size: 1.1em; color: #555; margin-top: 1.2em; }
    p { margin: 1em 0; }
    
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 20px;
      overflow-x: auto;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 0.85em;
      line-height: 1.4;
      margin: 1em 0;
      white-space: pre;
    }
    
    code { font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace; font-size: 0.9em; }
    :not(pre) > code { background: #f0f0f0; padding: 2px 6px; border-radius: 3px; color: #c7254e; }
    
    table { width: 100%; border-collapse: collapse; margin: 1em 0; }
    th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
    th { background: #f0f0f0; font-weight: 600; }
    tr:nth-child(even) { background: #fafafa; }
    
    ul, ol { padding-left: 2em; margin: 1em 0; }
    li { margin-bottom: 0.5em; }
    
    blockquote {
      border-left: 4px solid #0078d4;
      background: #f0f7ff;
      padding: 15px 20px;
      margin: 1em 0;
      border-radius: 0 6px 6px 0;
    }
    
    a { color: #0078d4; text-decoration: none; }
    a:hover { text-decoration: underline; }
    
    details { border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px 15px; margin: 1em 0; background: #fafafa; }
    summary { cursor: pointer; font-weight: 600; color: #0078d4; }
    hr { border: none; border-top: 1px solid #e0e0e0; margin: 2em 0; }
    
    @media print {
      .container { display: block; }
      .sidebar, .resizer { display: none; }
      .content { padding: 20px; overflow: visible; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="sidebar-header">ğŸ“‘ Inhaltsverzeichnis</div>
      <div class="sidebar-content">
        <ul>
        <li><a href="#contextpilot-mfa-konzept-v2.5"
        id="toc-contextpilot-mfa-konzept-v2.5">CONTEXTPILOT MFA-Konzept
        v2.5</a>
        <ul>
        <li><a
        href="#umstellung-auf-azure-function-mit-microsoft-agent-framework"
        id="toc-umstellung-auf-azure-function-mit-microsoft-agent-framework">Umstellung
        auf Azure Function mit Microsoft Agent Framework</a>
        <ul>
        <li><a href="#projektbeteiligte"
        id="toc-projektbeteiligte">Projektbeteiligte</a></li>
        </ul></li>
        <li><a href="#lokale-entwicklungsumgebung-starten"
        id="toc-lokale-entwicklungsumgebung-starten">ğŸš€ Lokale
        Entwicklungsumgebung starten</a>
        <ul>
        <li><a href="#voraussetzungen"
        id="toc-voraussetzungen">Voraussetzungen</a></li>
        <li><a href="#terminal-1-frontend-vite-dev-server"
        id="toc-terminal-1-frontend-vite-dev-server">Terminal 1:
        Frontend (Vite Dev Server)</a></li>
        <li><a href="#terminal-2-proxy-server-node.js"
        id="toc-terminal-2-proxy-server-node.js">Terminal 2: Proxy
        Server (Node.js)</a></li>
        <li><a href="#terminal-3-azure-function-python-maf"
        id="toc-terminal-3-azure-function-python-maf">Terminal 3: Azure
        Function (Python + MAF)</a></li>
        <li><a href="#zusammenfassung-drei-terminals"
        id="toc-zusammenfassung-drei-terminals">Zusammenfassung: Drei
        Terminals</a></li>
        <li><a href="#wichtige-lokale-urls"
        id="toc-wichtige-lokale-urls">Wichtige lokale URLs</a></li>
        <li><a href="#typischer-workflow"
        id="toc-typischer-workflow">Typischer Workflow</a></li>
        <li><a href="#troubleshooting"
        id="toc-troubleshooting">Troubleshooting</a></li>
        <li><a href="#begriffserklÃ¤rung-mfa-vs.-maf"
        id="toc-begriffserklÃ¤rung-mfa-vs.-maf">BegriffserklÃ¤rung: MFA
        vs.Â MAF</a></li>
        </ul></li>
        <li><a href="#zusammenfassung" id="toc-zusammenfassung">1.
        Zusammenfassung</a></li>
        <li><a href="#implementierungsstatus-stand-5.-januar-2026"
        id="toc-implementierungsstatus-stand-5.-januar-2026">1.1
        Implementierungsstatus (Stand: 5. Januar 2026)</a>
        <ul>
        <li><a href="#was-bedeutet-das" id="toc-was-bedeutet-das">Was
        bedeutet das?</a></li>
        </ul></li>
        <li><a href="#architektur-vorher-vs.-nachher"
        id="toc-architektur-vorher-vs.-nachher">2. Architektur: Vorher
        vs.Â Nachher</a>
        <ul>
        <li><a href="#bestehende-architektur-bleibt-erhalten"
        id="toc-bestehende-architektur-bleibt-erhalten">2.1 Bestehende
        Architektur (bleibt erhalten!)</a></li>
        <li><a href="#erweiterte-architektur-neu-mfa-hinzugefÃ¼gt"
        id="toc-erweiterte-architektur-neu-mfa-hinzugefÃ¼gt">2.2
        Erweiterte Architektur (NEU: MFA hinzugefÃ¼gt)</a></li>
        </ul></li>
        <li><a
        href="#warum-diese-architektur-die-bestehenden-prozesse-nicht-zerstÃ¶rt"
        id="toc-warum-diese-architektur-die-bestehenden-prozesse-nicht-zerstÃ¶rt">3.
        Warum diese Architektur die bestehenden Prozesse nicht
        zerstÃ¶rt</a>
        <ul>
        <li><a href="#isolationsprinzip" id="toc-isolationsprinzip">3.1
        Isolationsprinzip</a></li>
        <li><a href="#code-Ã¤nderungen-im-proxy-minimal-invasiv"
        id="toc-code-Ã¤nderungen-im-proxy-minimal-invasiv">3.2
        Code-Ã„nderungen im Proxy (Minimal-invasiv)</a></li>
        <li><a href="#neue-funktion-fÃ¼r-mfa-komplett-isoliert"
        id="toc-neue-funktion-fÃ¼r-mfa-komplett-isoliert">3.3 Neue
        Funktion fÃ¼r MFA (komplett isoliert)</a></li>
        </ul></li>
        <li><a href="#azure-function-maf-implementation-im-detail"
        id="toc-azure-function-maf-implementation-im-detail">4. Azure
        Function: MAF-Implementation im Detail</a>
        <ul>
        <li><a href="#projektstruktur" id="toc-projektstruktur">4.1
        Projektstruktur</a></li>
        <li><a href="#requirements.txt-version-pinning-empfohlen"
        id="toc-requirements.txt-version-pinning-empfohlen">4.2
        requirements.txt (Version-Pinning â€“ empfohlen)</a></li>
        <li><a href="#maf-workflow-code-mfa_workflow.py"
        id="toc-maf-workflow-code-mfa_workflow.py">4.3 MAF Workflow Code
        (mfa_workflow.py)</a></li>
        <li><a href="#azure-function-entry-point-function_app.py"
        id="toc-azure-function-entry-point-function_app.py">4.4 Azure
        Function Entry Point (function_app.py)</a></li>
        <li><a href="#rolle-von-azureaiclient-im-contextpilot-maf-bild"
        id="toc-rolle-von-azureaiclient-im-contextpilot-maf-bild">4.5
        Rolle von <code>AzureAIClient</code> im CONTEXTPILOT-MAF
        Bild</a></li>
        <li><a href="#timeout-realitÃ¤t-fÃ¼r-http-trigger-consumption"
        id="toc-timeout-realitÃ¤t-fÃ¼r-http-trigger-consumption">4.6
        Timeout-RealitÃ¤t fÃ¼r HTTP Trigger (Consumption)</a></li>
        </ul></li>
        <li><a href="#auratriage-entscheidungslogik"
        id="toc-auratriage-entscheidungslogik">5. AURATriage:
        Entscheidungslogik</a>
        <ul>
        <li><a href="#neues-pattern-direct-response-v2.2"
        id="toc-neues-pattern-direct-response-v2.2">5.1 Neues Pattern:
        Direct Response (v2.2)</a></li>
        <li><a
        href="#system-instructions-fÃ¼r-auratriage-in-foundry-portal"
        id="toc-system-instructions-fÃ¼r-auratriage-in-foundry-portal">5.2
        System Instructions fÃ¼r AURATriage (in Foundry Portal)</a></li>
        <li><a href="#wie-die-entscheidung-verarbeitet-wird"
        id="toc-wie-die-entscheidung-verarbeitet-wird">5.3 Wie die
        Entscheidung verarbeitet wird</a></li>
        </ul></li>
        <li><a href="#alle-agent-instructions-backup"
        id="toc-alle-agent-instructions-backup">5.4 Alle Agent
        Instructions (Backup)</a>
        <ul>
        <li><a href="#auratriage-routing-agent"
        id="toc-auratriage-routing-agent">AURATriage (Routing
        Agent)</a></li>
        <li><a href="#auracontextpilotweb-web-search-agent"
        id="toc-auracontextpilotweb-web-search-agent">AURAContextPilotWeb
        (Web Search Agent)</a></li>
        <li><a href="#auracontextpilot-index-search-agent"
        id="toc-auracontextpilot-index-search-agent">AURAContextPilot
        (Index Search Agent)</a></li>
        <li><a
        href="#auracontextpilotresponsesynthesizer-synthesis-agent"
        id="toc-auracontextpilotresponsesynthesizer-synthesis-agent">AURAContextPilotResponseSynthesizer
        (Synthesis Agent)</a></li>
        </ul></li>
        <li><a href="#erweiterbarkeit-neue-agenten-hinzufÃ¼gen"
        id="toc-erweiterbarkeit-neue-agenten-hinzufÃ¼gen">6.
        Erweiterbarkeit: Neue Agenten hinzufÃ¼gen</a>
        <ul>
        <li><a href="#schritt-fÃ¼r-schritt"
        id="toc-schritt-fÃ¼r-schritt">6.1 Schritt-fÃ¼r-Schritt</a></li>
        </ul></li>
        <li><a href="#Ã¤nderungen-im-bestehenden-system"
        id="toc-Ã¤nderungen-im-bestehenden-system">7. Ã„nderungen im
        bestehenden System</a>
        <ul>
        <li><a href="#Ã¼bersicht-aller-Ã¤nderungen"
        id="toc-Ã¼bersicht-aller-Ã¤nderungen">7.1 Ãœbersicht aller
        Ã„nderungen</a></li>
        <li><a href="#proxy-Ã¤nderungen-im-detail"
        id="toc-proxy-Ã¤nderungen-im-detail">7.2 Proxy-Ã„nderungen im
        Detail</a></li>
        <li><a href="#umgebungsvariablen-.env.local"
        id="toc-umgebungsvariablen-.env.local">7.3 Umgebungsvariablen
        (.env.local)</a></li>
        </ul></li>
        <li><a href="#vergleich-foundry-workflow-vs.-mfa"
        id="toc-vergleich-foundry-workflow-vs.-mfa">8. Vergleich:
        Foundry Workflow vs.Â MFA</a></li>
        <li><a href="#implementierungsplan"
        id="toc-implementierungsplan">9. Implementierungsplan</a>
        <ul>
        <li><a href="#phase-1-azure-function-setup-1-tag"
        id="toc-phase-1-azure-function-setup-1-tag">Phase 1: Azure
        Function Setup (1 Tag)</a></li>
        <li><a href="#phase-2-auratriage-erstellen-0.5-tage"
        id="toc-phase-2-auratriage-erstellen-0.5-tage">Phase 2:
        AURATriage erstellen (0.5 Tage)</a></li>
        <li><a href="#phase-3-maf-workflow-implementieren-1-2-tage"
        id="toc-phase-3-maf-workflow-implementieren-1-2-tage">Phase 3:
        MAF Workflow implementieren (1-2 Tage)</a></li>
        <li><a href="#phase-4-proxy-integration-0.5-tage"
        id="toc-phase-4-proxy-integration-0.5-tage">Phase 4:
        Proxy-Integration (0.5 Tage)</a></li>
        <li><a href="#phase-5-frontend-erweiterung-0.5-tage"
        id="toc-phase-5-frontend-erweiterung-0.5-tage">Phase 5:
        Frontend-Erweiterung (0.5 Tage)</a></li>
        </ul></li>
        <li><a href="#risikobewertung" id="toc-risikobewertung">10.
        Risikobewertung</a></li>
        <li><a href="#entscheidungen-review-abgeschlossen"
        id="toc-entscheidungen-review-abgeschlossen">11. Entscheidungen
        (Review abgeschlossen)</a></li>
        <li><a href="#referenzen" id="toc-referenzen">12.
        Referenzen</a></li>
        <li><a href="#maf-recherche-validiert-mit-quellen"
        id="toc-maf-recherche-validiert-mit-quellen">13. MAF Recherche
        (validiert, mit Quellen)</a></li>
        <li><a href="#externer-entwickler-guide-verbindlich"
        id="toc-externer-entwickler-guide-verbindlich">14. Externer
        Entwickler Guide (verbindlich)</a>
        <ul>
        <li><a href="#kurze-projektbeschreibung"
        id="toc-kurze-projektbeschreibung">14.1 Kurze
        Projektbeschreibung</a></li>
        <li><a href="#ziel" id="toc-ziel">14.2 Ziel</a></li>
        <li><a href="#plan-34-werktage" id="toc-plan-34-werktage">14.3
        Plan (3â€“4 Werktage)</a></li>
        <li><a href="#settings-konkrete-werte-direkt-Ã¼bernehmbar"
        id="toc-settings-konkrete-werte-direkt-Ã¼bernehmbar">14.4
        Settings (konkrete Werte â€“ direkt Ã¼bernehmbar)</a></li>
        </ul></li>
        <li><a href="#referenzen-zusÃ¤tzlich-zu-kap.-12"
        id="toc-referenzen-zusÃ¤tzlich-zu-kap.-12">15. Referenzen
        (zusÃ¤tzlich zu Kap. 12)</a></li>
        <li><a href="#deployment-guide" id="toc-deployment-guide">16.
        Deployment Guide</a>
        <ul>
        <li><a href="#executive-summary" id="toc-executive-summary">16.1
        Executive Summary</a></li>
        <li><a href="#ressourcen-architektur"
        id="toc-ressourcen-architektur">16.2
        Ressourcen-Architektur</a></li>
        <li><a href="#azure-function-app-deployment"
        id="toc-azure-function-app-deployment">16.3 Azure Function App
        Deployment</a></li>
        <li><a href="#managed-identity-und-rbac"
        id="toc-managed-identity-und-rbac">16.4 Managed Identity und
        RBAC</a></li>
        <li><a href="#proxy-server-konfiguration"
        id="toc-proxy-server-konfiguration">16.5 Proxy Server
        Konfiguration</a></li>
        <li><a href="#cicd-pipeline-github-actions"
        id="toc-cicd-pipeline-github-actions">16.6 CI/CD Pipeline
        (GitHub Actions)</a></li>
        <li><a href="#troubleshooting-1" id="toc-troubleshooting-1">16.7
        Troubleshooting</a></li>
        <li><a href="#verifizierung" id="toc-verifizierung">16.8
        Verifizierung</a></li>
        <li><a href="#quick-reference" id="toc-quick-reference">16.9
        Quick Reference</a></li>
        </ul></li>
        </ul></li>
        </ul>
      </div>
    </div>
    <div class="resizer" id="resizer"></div>
    <div class="content">
      <div class="content-inner">
        <h1 id="contextpilot-mfa-konzept-v2.5">CONTEXTPILOT MFA-Konzept
        v2.5</h1>
        <h2
        id="umstellung-auf-azure-function-mit-microsoft-agent-framework">Umstellung
        auf Azure Function mit Microsoft Agent Framework</h2>
        <p><strong>Version:</strong> 2.5<br />
        <strong>Datum:</strong> 5. Januar 2026<br />
        <strong>Status:</strong> Produktiv â€“ Zwischenstand (siehe
        Implementierungsstatus)<br />
        <strong>Technologie-Stack:</strong> Azure Function (Python) +
        Microsoft Agent Framework (MAF)</p>
        <hr />
        <h3 id="projektbeteiligte">Projektbeteiligte</h3>
        <table>
        <thead>
        <tr>
        <th>Rolle</th>
        <th>Name/Tool</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><strong>Auftraggeber</strong></td>
        <td>Martin HÃ¤mmerli</td>
        </tr>
        <tr>
        <td><strong>Entwickler</strong></td>
        <td>GitHub Copilot / Claude Opus 4.5</td>
        </tr>
        <tr>
        <td><strong>Berater</strong></td>
        <td>ChatGPT 5.2 / Extended Thinking</td>
        </tr>
        </tbody>
        </table>
        <p><strong>GitHub Repository:</strong> <a
        href="https://github.com/JohnMavic/ContextPilot">https://github.com/JohnMavic/ContextPilot</a></p>
        <hr />
        <h2 id="lokale-entwicklungsumgebung-starten">ğŸš€ Lokale
        Entwicklungsumgebung starten</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Um CONTEXTPILOT lokal
        zu entwickeln und zu testen, mÃ¼ssen drei Komponenten gestartet
        werden: (1) Das React-Frontend via Vite, (2) der
        Node.js-Proxy-Server, und (3) die Python Azure Function. Jede
        Komponente lÃ¤uft in einem eigenen Terminal-Fenster.</p>
        </blockquote>
        <h3 id="voraussetzungen">Voraussetzungen</h3>
        <ul>
        <li>Node.js 22.x installiert</li>
        <li>Python 3.11 installiert</li>
        <li>Azure Functions Core Tools
        (<code>npm install -g azure-functions-core-tools@4</code>)</li>
        <li>Azure CLI (<code>az login</code> bereits ausgefÃ¼hrt)</li>
        <li><code>.env.local</code> Datei in
        <code>live-transcriber/</code> mit korrekten Werten</li>
        <li><code>local.settings.json</code> in
        <code>contextpilot-mfa-function/</code> (aus Template
        erstellen)</li>
        </ul>
        <h3 id="terminal-1-frontend-vite-dev-server">Terminal 1:
        Frontend (Vite Dev Server)</h3>
        <div class="sourceCode" id="cb1"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> E<span class="op">:</span>\ContextPilot\live-transcriber</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>npm run dev</span></code></pre></div>
        <p><strong>Erwartete Ausgabe:</strong></p>
        <pre><code>  VITE v7.2.4  ready in 500 ms

  âœ  Local:   http://localhost:5173/
  âœ  Network: use --host to expose</code></pre>
        <p><strong>Ã–ffne:</strong> http://localhost:5173/</p>
        <hr />
        <h3 id="terminal-2-proxy-server-node.js">Terminal 2: Proxy
        Server (Node.js)</h3>
        <div class="sourceCode" id="cb3"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> E<span class="op">:</span>\ContextPilot\live-transcriber</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>npm <span class="fu">start</span></span></code></pre></div>
        <p><strong>Oder direkt:</strong></p>
        <div class="sourceCode" id="cb4"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> E<span class="op">:</span>\ContextPilot\live-transcriber</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>node proxy-server<span class="op">.</span><span class="fu">js</span></span></code></pre></div>
        <p><strong>Erwartete Ausgabe:</strong></p>
        <pre><code>[Proxy] Server listening on port 3001
[Proxy] Loaded 2 agents, 1 workflow, 1 MFA</code></pre>
        <p><strong>API verfÃ¼gbar unter:</strong>
        http://localhost:3001/</p>
        <hr />
        <h3 id="terminal-3-azure-function-python-maf">Terminal 3: Azure
        Function (Python + MAF)</h3>
        <div class="sourceCode" id="cb6"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> E<span class="op">:</span>\ContextPilot\contextpilot-mfa-function</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Python Virtual Environment aktivieren (falls nicht aktiv)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">..</span>\<span class="op">.</span><span class="fu">venv</span>\Scripts\Activate<span class="op">.</span><span class="fu">ps1</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Function starten</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>func <span class="fu">start</span> <span class="op">--</span>port <span class="dv">7071</span> <span class="op">--</span>verbose</span></code></pre></div>
        <p><strong>Erwartete Ausgabe:</strong></p>
        <pre><code>Azure Functions Core Tools
...
Functions:
        healthz: [GET] http://localhost:7071/api/healthz
        mfa_endpoint: [POST] http://localhost:7071/api/mfa</code></pre>
        <p><strong>Health Check testen:</strong></p>
        <div class="sourceCode" id="cb8"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Invoke-RestMethod</span> <span class="op">-</span>Uri <span class="st">&quot;http://localhost:7071/api/healthz&quot;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Erwartung: {&quot;ok&quot;: true, &quot;version&quot;: &quot;2.4&quot;}</span></span></code></pre></div>
        <hr />
        <h3 id="zusammenfassung-drei-terminals">Zusammenfassung: Drei
        Terminals</h3>
        <table>
        <colgroup>
        <col style="width: 31%" />
        <col style="width: 25%" />
        <col style="width: 25%" />
        <col style="width: 18%" />
        </colgroup>
        <thead>
        <tr>
        <th>Terminal</th>
        <th>Ordner</th>
        <th>Befehl</th>
        <th>Port</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><strong>1 - Frontend</strong></td>
        <td><code>live-transcriber</code></td>
        <td><code>npm run dev</code></td>
        <td>5173</td>
        </tr>
        <tr>
        <td><strong>2 - Proxy</strong></td>
        <td><code>live-transcriber</code></td>
        <td><code>npm start</code></td>
        <td>3001</td>
        </tr>
        <tr>
        <td><strong>3 - Function</strong></td>
        <td><code>contextpilot-mfa-function</code></td>
        <td><code>func start --port 7071</code></td>
        <td>7071</td>
        </tr>
        </tbody>
        </table>
        <h3 id="wichtige-lokale-urls">Wichtige lokale URLs</h3>
        <table>
        <colgroup>
        <col style="width: 50%" />
        <col style="width: 20%" />
        <col style="width: 29%" />
        </colgroup>
        <thead>
        <tr>
        <th>Komponente</th>
        <th>URL</th>
        <th>Zweck</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td>Frontend</td>
        <td>http://localhost:5173/</td>
        <td>React App (UI)</td>
        </tr>
        <tr>
        <td>Proxy API</td>
        <td>http://localhost:3001/agents</td>
        <td>Agent-Liste abrufen</td>
        </tr>
        <tr>
        <td>Function Health</td>
        <td>http://localhost:7071/api/healthz</td>
        <td>Function-Status prÃ¼fen</td>
        </tr>
        <tr>
        <td>Function MFA</td>
        <td>http://localhost:7071/api/mfa</td>
        <td>MFA-Endpoint testen</td>
        </tr>
        </tbody>
        </table>
        <h3 id="typischer-workflow">Typischer Workflow</h3>
        <ol type="1">
        <li><strong>Alle drei Terminals starten</strong> (Reihenfolge
        egal)</li>
        <li><strong>Frontend Ã¶ffnen:</strong>
        http://localhost:5173/</li>
        <li><strong>Agent-Dropdown:</strong> Sollte â€œMFA (Multi-Agent)â€
        zeigen</li>
        <li><strong>Frage stellen:</strong> Die Anfrage geht Frontend â†’
        Proxy â†’ Function â†’ AI Foundry</li>
        </ol>
        <h3 id="troubleshooting">Troubleshooting</h3>
        <table>
        <colgroup>
        <col style="width: 52%" />
        <col style="width: 47%" />
        </colgroup>
        <thead>
        <tr>
        <th>Problem</th>
        <th>LÃ¶sung</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><code>func: command not found</code></td>
        <td><code>npm install -g azure-functions-core-tools@4</code></td>
        </tr>
        <tr>
        <td>Function zeigt â€œ0 Functionsâ€</td>
        <td><code>local.settings.json</code> prÃ¼fen, alle ENV VARs
        gesetzt?</td>
        </tr>
        <tr>
        <td>Proxy Error â€œECONNREFUSEDâ€</td>
        <td>Function lÃ¤uft? Port 7071 frei?</td>
        </tr>
        <tr>
        <td>Frontend zeigt keine Agents</td>
        <td>Proxy lÃ¤uft? <code>.env.local</code> korrekt?</td>
        </tr>
        </tbody>
        </table>
        <hr />
        <h3 id="begriffserklÃ¤rung-mfa-vs.-maf">BegriffserklÃ¤rung: MFA
        vs.Â MAF</h3>
        <table>
        <colgroup>
        <col style="width: 32%" />
        <col style="width: 32%" />
        <col style="width: 35%" />
        </colgroup>
        <thead>
        <tr>
        <th>AbkÃ¼rzung</th>
        <th>Bedeutung</th>
        <th>Verwendung</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><strong>MFA</strong></td>
        <td><strong>M</strong>ulti-Agent <strong>F</strong>low
        <strong>A</strong>rchitektur</td>
        <td>Projektspezifische Bezeichnung fÃ¼r die Multi-Agent-LÃ¶sung in
        CONTEXTPILOT (Ordner, Variablen, API-Responses)</td>
        </tr>
        <tr>
        <td><strong>MAF</strong></td>
        <td><strong>M</strong>icrosoft <strong>A</strong>gent
        <strong>F</strong>ramework</td>
        <td>Offizielles SDK (<code>agent-framework-core</code>,
        <code>agent-framework-azure-ai</code>)</td>
        </tr>
        </tbody>
        </table>
        <blockquote>
        <p><strong>Hinweis:</strong> â€œMFAâ€ ist <strong>nicht</strong> zu
        verwechseln mit â€œMulti-Factor Authenticationâ€. Im
        CONTEXTPILOT-Kontext bezeichnet MFA stets die
        Multi-Agent-Architektur, die auf dem Microsoft Agent Framework
        (MAF) basiert.</p>
        </blockquote>
        <hr />
        <h2 id="zusammenfassung">1. Zusammenfassung</h2>
        <p>Dieses Konzept beschreibt die Erweiterung von CONTEXTPILOT um
        eine <strong>MFA-Option</strong> (Multi-Agent Framework), die
        Agents Ã¼ber das Microsoft Agent Framework in einer Azure
        Function orchestriert.</p>
        <p><strong>Kernziele (Endziel):</strong> - âœ… Bestehende
        FunktionalitÃ¤t (Agent, Workflow) bleibt
        <strong>unverÃ¤ndert</strong> - âœ… Neue MFA-Option nutzt
        <strong>offizielles Microsoft Agent Framework</strong> - â³
        Echte ParallelitÃ¤t via
        <code>add_multi_selection_edge_group()</code> (dynamisch) +
        <code>add_fan_in_edges()</code> (Fan-In) <em>(noch nicht
        implementiert)</em> - âœ… Dynamische Agent-Auswahl durch
        <strong>AURATriage</strong> - âœ… Stabil durch Version-Pinning +
        kontrollierte Updates (Upgrade nur nach Test)</p>
        <hr />
        <h2 id="implementierungsstatus-stand-5.-januar-2026">1.1
        Implementierungsstatus (Stand: 5. Januar 2026)</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Diese Tabelle zeigt
        transparent, welche Teile des Konzepts bereits produktiv
        implementiert sind und welche noch ausstehen. Die Kernziele oben
        beschreiben das <strong>Endziel</strong> der Architektur â€“ der
        aktuelle Stand ist ein funktionierender
        <strong>Zwischenstand</strong> mit sequenzieller
        Agent-Orchestrierung.</p>
        </blockquote>
        <table>
        <colgroup>
        <col style="width: 37%" />
        <col style="width: 40%" />
        <col style="width: 21%" />
        </colgroup>
        <thead>
        <tr>
        <th>Dokumentiert</th>
        <th>Implementiert</th>
        <th>Status</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td>Microsoft Agent Framework (MAF)</td>
        <td>âœ… Ja</td>
        <td>agent-framework-core, agent-framework-azure-ai
        installiert</td>
        </tr>
        <tr>
        <td>AzureAIClient fÃ¼r Agent-Aufrufe</td>
        <td>âœ… Ja</td>
        <td>Wird in mfa_workflow.py verwendet</td>
        </tr>
        <tr>
        <td>AURATriage fÃ¼r Routing</td>
        <td>âœ… Ja</td>
        <td>Funktioniert, gibt direct/web/context zurÃ¼ck</td>
        </tr>
        <tr>
        <td>AURAContextPilotQuick</td>
        <td>âœ… Ja</td>
        <td>Wird bei direct=true aufgerufen</td>
        </tr>
        <tr>
        <td>AURAContextPilotWeb</td>
        <td>âœ… Ja</td>
        <td>Wird bei web=true aufgerufen</td>
        </tr>
        <tr>
        <td>AURAContextPilot</td>
        <td>âœ… Ja</td>
        <td>Wird bei context=true aufgerufen</td>
        </tr>
        <tr>
        <td>AURASynthesizer</td>
        <td>âœ… Ja</td>
        <td>Wird bei web+context aufgerufen</td>
        </tr>
        <tr>
        <td>WorkflowBuilder API</td>
        <td>âŒ Nein</td>
        <td>Nicht verwendet (geplant)</td>
        </tr>
        <tr>
        <td>add_multi_selection_edge_group()</td>
        <td>âŒ Nein</td>
        <td>Nicht verwendet (geplant)</td>
        </tr>
        <tr>
        <td>add_fan_in_edges()</td>
        <td>âŒ Nein</td>
        <td>Nicht verwendet (geplant)</td>
        </tr>
        <tr>
        <td>Echte ParallelitÃ¤t (Fan-Out)</td>
        <td>âŒ Nein</td>
        <td>Agents laufen sequenziell</td>
        </tr>
        <tr>
        <td>Deklarativer Graph</td>
        <td>âŒ Nein</td>
        <td>Imperative if/else Logik</td>
        </tr>
        </tbody>
        </table>
        <h3 id="was-bedeutet-das">Was bedeutet das?</h3>
        <p><strong>Aktueller Zwischenstand:</strong> - Die
        MFA-Architektur funktioniert vollstÃ¤ndig - Triage-basiertes
        Routing ist produktiv - Alle 5 Agents (Triage, Quick, Web,
        Context, Synthesizer) werden korrekt aufgerufen - Bei web=true
        UND context=true werden beide Agents aufgerufen, <strong>aber
        nacheinander (sequenziell)</strong></p>
        <p><strong>Noch nicht implementiert (Endziel):</strong> -
        Parallele AusfÃ¼hrung von Web + Context Agent (Fan-Out) -
        MAF-native WorkflowBuilder API mit deklarativem Graph -
        Latenzreduktion von ~15s auf ~7-10s bei Dual-Agent-Anfragen</p>
        <p><strong>Warum ist das akzeptabel?</strong> - Der sequenzielle
        Ablauf ist <strong>funktional korrekt</strong> â€“ nur langsamer -
        FÃ¼r die aktuelle Nutzung (0-60 Min/Tag) ist die Latenz
        akzeptabel - Die Architektur ist <strong>vorbereitet</strong>
        fÃ¼r Parallelisierung (keine strukturellen Ã„nderungen nÃ¶tig)</p>
        <hr />
        <h2 id="architektur-vorher-vs.-nachher">2. Architektur: Vorher
        vs.Â Nachher</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die
        CONTEXTPILOT-Architektur besteht aus drei Komponenten:
        React-Frontend (SWA), Node.js-Proxy (App Service), und Azure AI
        Foundry Agents. Die MFA-Erweiterung fÃ¼gt eine Python-basierte
        Azure Function hinzu, die mehrere Agents orchestriert (aktuell
        sequenziell, Endziel: parallel) â€“ ohne die bestehenden Wege
        (Agent/Workflow) zu verÃ¤ndern.</p>
        </blockquote>
        <h3 id="bestehende-architektur-bleibt-erhalten">2.1 Bestehende
        Architektur (bleibt erhalten!)</h3>
        <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BESTEHEND â€“ WIRD NICHT VERÃ„NDERT                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   [SWA Frontend]                                                    â”‚
â”‚        â”‚                                                            â”‚
â”‚        â”‚ POST /agent                                                â”‚
â”‚        â†“                                                            â”‚
â”‚   [Proxy - App Service]                                             â”‚
â”‚        â”‚                                                            â”‚
â”‚        â”œâ”€â”€â”€ type: &quot;agent&quot;    â†’ Foundry Agent (direkt)               â”‚
â”‚        â”‚                                                            â”‚
â”‚        â””â”€â”€â”€ type: &quot;workflow&quot; â†’ Foundry Workflow (sequenziell)       â”‚
â”‚                                    â”‚                                â”‚
â”‚                                    â†“                                â”‚
â”‚                              CONTEXTPILOT Workflow                  â”‚
â”‚                              (Web â†’ Context â†’ Synthesizer)          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        <h3 id="erweiterte-architektur-neu-mfa-hinzugefÃ¼gt">2.2
        Erweiterte Architektur (NEU: MFA hinzugefÃ¼gt)</h3>
        <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ERWEITERT â€“ NEUE MFA-OPTION                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   [SWA Frontend]                                                    â”‚
â”‚        â”‚                                                            â”‚
â”‚        â”‚ POST /agent                                                â”‚
â”‚        â†“                                                            â”‚
â”‚   [Proxy - App Service]                                             â”‚
â”‚        â”‚                                                            â”‚
â”‚        â”œâ”€â”€â”€ type: &quot;agent&quot;    â†’ Foundry Agent        (unverÃ¤ndert)   â”‚
â”‚        â”‚                                                            â”‚
â”‚        â”œâ”€â”€â”€ type: &quot;workflow&quot; â†’ Foundry Workflow     (unverÃ¤ndert)   â”‚
â”‚        â”‚                                                            â”‚
â”‚        â””â”€â”€â”€ type: &quot;mfa&quot;      â†’ Azure Function (NEU) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                                                                â”‚    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚   â”‚                                                                 â”‚
â”‚   â–¼                                                                 â”‚
â”‚   [Azure Function - Python + MAF]                                   â”‚
â”‚        â”‚                                                            â”‚
â”‚        â”‚  Microsoft Agent Framework                                 â”‚
â”‚        â”‚  WorkflowBuilder + fan_out/fan_in                          â”‚
â”‚        â”‚                                                            â”‚
â”‚        â–¼                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚ AURATriage  â”‚ â† Entscheidet welche Agenten                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚          â”‚                                                          â”‚
â”‚          â”‚ add_multi_selection_edge_group()  (ENDZIEL - noch nicht impl.)â”‚
â”‚          â”‚                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚   â–¼             â–¼              â–¼                                    â”‚
â”‚ [Web]       [Context]     [Future...]   â† Endziel: Parallel!       â”‚
â”‚   â”‚             â”‚              â”‚            (aktuell: sequenziell)  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚          â”‚                                                          â”‚
â”‚          â”‚ add_fan_in_edges()  (ENDZIEL - noch nicht implementiert) â”‚
â”‚          â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚ Synthesizer â”‚ â† Fasst alles zusammen                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        <hr />
        <h2
        id="warum-diese-architektur-die-bestehenden-prozesse-nicht-zerstÃ¶rt">3.
        Warum diese Architektur die bestehenden Prozesse nicht
        zerstÃ¶rt</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Der MFA-Weg ist
        vollstÃ¤ndig isoliert vom bestehenden Code. Im
        <code>proxy-server.js</code> wird lediglich eine
        <code>if</code>-Bedingung
        (<code>if (agent.type === "mfa")</code>) hinzugefÃ¼gt, die zu
        einer komplett neuen Funktion <code>handleMFARequest()</code>
        weiterleitet. Bestehende Funktionen
        <code>handleAgentRequest()</code> und
        <code>handleWorkflowRequest()</code> bleiben unverÃ¤ndert.</p>
        </blockquote>
        <h3 id="isolationsprinzip">3.1 Isolationsprinzip</h3>
        <table>
        <colgroup>
        <col style="width: 19%" />
        <col style="width: 26%" />
        <col style="width: 26%" />
        <col style="width: 26%" />
        </colgroup>
        <thead>
        <tr>
        <th>Aspekt</th>
        <th>Bestehend</th>
        <th>MFA (Neu)</th>
        <th>Konflikt?</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><strong>Routing-Logik</strong></td>
        <td><code>type: "agent"</code> oder
        <code>type: "workflow"</code></td>
        <td><code>type: "mfa"</code> (NEU)</td>
        <td>âŒ Nein</td>
        </tr>
        <tr>
        <td><strong>Endpoint</strong></td>
        <td><code>/agent</code> (gleich)</td>
        <td><code>/agent</code> (gleich)</td>
        <td>âŒ Nein - Unterscheidung via
        <code>currentAgentId</code></td>
        </tr>
        <tr>
        <td><strong>Proxy-Code</strong></td>
        <td><code>handleAgentRequest()</code>,
        <code>handleWorkflowRequest()</code></td>
        <td><code>handleMFARequest()</code> (NEU)</td>
        <td>âŒ Separate Funktion</td>
        </tr>
        <tr>
        <td><strong>Foundry Agenten</strong></td>
        <td>Direkt aufgerufen</td>
        <td>Indirekt via MAF</td>
        <td>âŒ Agenten unverÃ¤ndert</td>
        </tr>
        </tbody>
        </table>
        <h3 id="code-Ã¤nderungen-im-proxy-minimal-invasiv">3.2
        Code-Ã„nderungen im Proxy (Minimal-invasiv)</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die einzige Ã„nderung an
        bestehendem Code ist eine <code>if</code>-Bedingung in
        <code>handleAgentRequest()</code>: Wenn
        <code>agent.type === "mfa"</code>, wird zu
        <code>handleMFARequest()</code> verzweigt. Die bestehenden Pfade
        fÃ¼r <code>type: "agent"</code> und <code>type: "workflow"</code>
        bleiben vÃ¶llig unverÃ¤ndert.</p>
        </blockquote>
        <div class="sourceCode" id="cb11"><pre
        class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// proxy-server.js - handleAgentRequest()</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">handleAgentRequest</span>(req<span class="op">,</span> res<span class="op">,</span> body) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> agent <span class="op">=</span> <span class="fu">getCurrentAgent</span>()<span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// BESTEHEND - unverÃ¤ndert</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (agent<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&quot;workflow&quot;</span>) {</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">handleWorkflowRequest</span>(req<span class="op">,</span> res<span class="op">,</span> body<span class="op">,</span> agent)<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// NEU - nur diese Zeilen hinzufÃ¼gen</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (agent<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&quot;mfa&quot;</span>) {</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">handleMFARequest</span>(req<span class="op">,</span> res<span class="op">,</span> body<span class="op">,</span> agent)<span class="op">;</span>  <span class="co">// â†’ Azure Function</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// BESTEHEND - Rest der Agent-Logik unverÃ¤ndert</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
        <h3 id="neue-funktion-fÃ¼r-mfa-komplett-isoliert">3.3 Neue
        Funktion fÃ¼r MFA (komplett isoliert)</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die Funktion
        <code>handleMFARequest()</code> ist komplett neu und berÃ¼hrt
        keinen bestehenden Code. Sie ruft die Azure Function Ã¼ber HTTP
        auf, Ã¼bergibt den User-Prompt, und gibt die Antwort zurÃ¼ck.
        <strong>Keine Retries</strong> â€“ bei Rate Limits (50k TPM)
        wÃ¼rden Retries das Problem verschlimmern. Bei 5xx-Fehlern gibt
        es einen optionalen Fallback auf den CONTEXTPILOT-Workflow.</p>
        </blockquote>
        <div class="sourceCode" id="cb12"><pre
        class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// proxy-server.js - handleMFARequest()</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">handleMFARequest</span>(req<span class="op">,</span> res<span class="op">,</span> body<span class="op">,</span> mfaConfig) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[MFA] Request for: </span><span class="sc">${</span>mfaConfig<span class="op">.</span><span class="at">label</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> correlationId <span class="op">=</span> req<span class="op">.</span><span class="at">headers</span>[<span class="st">&quot;x-correlation-id&quot;</span>] <span class="op">||</span> <span class="fu">randomUUID</span>()<span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> payload <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(body <span class="op">||</span> <span class="st">&quot;{}&quot;</span>)<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> prompt <span class="op">=</span> payload<span class="op">.</span><span class="at">prompt</span><span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Timeout: 200 Sekunden (Rate Limit ist 50k TPM)</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> timeoutMs <span class="op">=</span> <span class="pp">parseInt</span>(<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">MFA_PROXY_TIMEOUT_MS</span> <span class="op">||</span> <span class="st">&quot;200000&quot;</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// KEINE Retries - bei Rate Limits wÃ¼rden Retries das Problem verschlimmern</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> maxRetries <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> headers <span class="op">=</span> {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span><span class="op">,</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;x-correlation-id&quot;</span><span class="op">:</span> correlationId<span class="op">,</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (mfaConfig<span class="op">.</span><span class="at">functionKey</span>) {</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    headers[<span class="st">&quot;x-functions-key&quot;</span>] <span class="op">=</span> mfaConfig<span class="op">.</span><span class="at">functionKey</span><span class="op">;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> resp <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(mfaConfig<span class="op">.</span><span class="at">endpoint</span><span class="op">,</span> {</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">,</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ prompt })<span class="op">,</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> resp<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Response mit allen MFA-Metadaten</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">200</span><span class="op">,</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> })<span class="op">;</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">end</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">output_text</span><span class="op">:</span> result<span class="op">.</span><span class="at">output_text</span><span class="op">,</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">workflow</span><span class="op">:</span> <span class="st">&quot;mfa&quot;</span><span class="op">,</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">agents_used</span><span class="op">:</span> result<span class="op">.</span><span class="at">agents_used</span> <span class="op">||</span> []<span class="op">,</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">routing</span><span class="op">:</span> result<span class="op">.</span><span class="at">routing</span> <span class="op">||</span> {}<span class="op">,</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
        <hr />
        <h2 id="azure-function-maf-implementation-im-detail">4. Azure
        Function: MAF-Implementation im Detail</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die Azure Function ist
        eine Python 3.11-Anwendung, die im Ordner
        <code>contextpilot-mfa-function/</code> liegt. Sie verwendet das
        Microsoft Agent Framework (MAF) SDK, um Azure AI Foundry Agents
        aufzurufen. Der Einstiegspunkt ist <code>function_app.py</code>
        (HTTP-Trigger), die Workflow-Logik liegt in
        <code>mfa_workflow.py</code>.</p>
        </blockquote>
        <h3 id="projektstruktur">4.1 Projektstruktur</h3>
        <blockquote>
        <p>âš ï¸ <strong>KORREKTUR (26.12.2025):</strong> Die ursprÃ¼ngliche
        Struktur war zu komplex. Der <code>agents/</code> Ordner wurde
        nicht benÃ¶tigt.</p>
        </blockquote>
        <details>
        <summary>
        âŒ <span style="color:red"><b>FALSCH - UrsprÃ¼ngliche
        Konzept-Struktur</b></span>
        </summary>
        <pre><code>contextpilot-mfa-function/
â”œâ”€â”€ function_app.py          # Azure Function Entry Point
â”œâ”€â”€ mfa_workflow.py          # MAF Workflow Definition
â”œâ”€â”€ agents/                   âŒ NICHT BENÃ–TIGT
â”‚   â””â”€â”€ foundry_agents.py    âŒ NICHT BENÃ–TIGT
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ host.json
â””â”€â”€ local.settings.json</code></pre>
        </details>
        <p>âœ… <strong>KORREKT - TatsÃ¤chliche
        Produktiv-Struktur:</strong></p>
        <pre><code>contextpilot-mfa-function/
â”œâ”€â”€ function_app.py          # Azure Function Entry Point (mit Lazy Import!)
â”œâ”€â”€ mfa_workflow.py          # MFA Workflow-Logik (direkt, ohne Executor-Klassen)
â”œâ”€â”€ requirements.txt         # MUSS agent-framework-azure-ai enthalten!
â”œâ”€â”€ host.json
â”œâ”€â”€ local.settings.json.template  # Template (local.settings.json nicht committen!)
â””â”€â”€ .gitignore</code></pre>
        <p><strong>Wichtige Unterschiede:</strong> - Kein
        <code>agents/</code> Ordner nÃ¶tig - alle Logik in
        <code>mfa_workflow.py</code> - Keine separaten Executor-Klassen
        - direkter async/await Flow -
        <code>local.settings.json.template</code> statt der echten Datei
        (Secrets!)</p>
        <h3 id="requirements.txt-version-pinning-empfohlen">4.2
        requirements.txt (Version-Pinning â€“ empfohlen)</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die Datei
        <code>requirements.txt</code> listet alle Python-Pakete, die die
        Azure Function benÃ¶tigt. Kritisch sind zwei MAF-Pakete:
        <code>agent-framework-core</code> (Basis-SDK) und
        <code>agent-framework-azure-ai</code> (Azure AI Foundry
        Integration). Ohne das zweite Paket erscheint der Fehler â€œ0
        Functions registeredâ€ beim Deployment.</p>
        </blockquote>
        <blockquote>
        <p>Wichtig: MAF/Foundry SDKs sind teilweise Preview/Beta.
        <strong>Du darfst keine unpinned
        <code>--pre</code>-Installationen deployen.</strong> Ziel:
        reproduzierbares Deployment ohne â€œdriftâ€ durch transitive
        Pre-Release Updates.</p>
        </blockquote>
        <pre class="text"><code># Azure Functions Runtime
azure-functions==1.13.3

# Microsoft Agent Framework (MAF) â€“ Pin auf eine getestete Version
# agent-framework-core ist das Base-Package
# agent-framework-azure-ai enthÃ¤lt AzureAIClient (fÃ¼r Azure AI Foundry Integration)
agent-framework-core==1.0.0b251223
agent-framework-azure-ai==1.0.0b251223

# azure-ai-projects V2 fÃ¼r existing agents by name
azure-ai-projects==2.0.0b2

# HTTP stack
aiohttp==3.13.2

# Auth / Typing
azure-identity&gt;=1.17.0</code></pre>
        <p>Hinweis zur Reproduzierbarkeit: - PoC: obige Pins reichen in
        der Regel. - Produktiv/Compliance: zusÃ¤tzlich ein Lockfile
        erzeugen (z.B. <code>pip-tools</code>/<code>uv lock</code>) und
        exakt daraus deployen.</p>
        <h3 id="maf-workflow-code-mfa_workflow.py">4.3 MAF Workflow Code
        (mfa_workflow.py)</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die Datei
        <code>mfa_workflow.py</code> enthÃ¤lt die Funktion
        <code>run_mfa_workflow(prompt)</code>, die den Multi-Agent-Flow
        ausfÃ¼hrt. Der Flow ist: (1) AURATriage entscheidet das Routing,
        (2) je nach Routing werden AURAContextPilotWeb und/oder
        AURAContextPilot aufgerufen, (3) bei zwei Agents fasst der
        Synthesizer die Ergebnisse zusammen. Die Agents werden per
        <code>agent_name=</code> + <code>use_latest_version=True</code>
        aufgelÃ¶st.</p>
        </blockquote>
        <blockquote>
        <p>âš ï¸ <strong>KORREKTUR (26.12.2025):</strong> Die Annahmen zu
        <code>agent_id</code> und dem Import-Pfad waren falsch!</p>
        </blockquote>
        <details>
        <summary>
        âŒ <span style="color:red"><b>FALSCH - UrsprÃ¼ngliche
        Konzept-Annahmen</b></span>
        </summary>
        <div class="sourceCode" id="cb16"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">CONTEXTPILOT MFA Workflow (MAF, Python)</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">Pattern: Triage -&gt; Fan-Out (parallel) -&gt; Fan-In -&gt; Synthesizer</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">Wichtig:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">- Bestehende Foundry Agents werden als *existing agents* per agent_id verwendet.  âŒ FALSCH</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Kein &quot;resolve by name&quot; annehmen.  âŒ FALSCH - resolve by name funktioniert!</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">- SDK-default ENV VARs verwenden (AZURE_AI_PROJECT_ENDPOINT / AZURE_AI_MODEL_DEPLOYMENT_NAME).</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
        </details>
        <p>âœ… <strong>KORREKT - TatsÃ¤chliche
        Implementation:</strong></p>
        <div class="sourceCode" id="cb17"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">CONTEXTPILOT MFA Workflow v2.4 (MAF, Python)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">Korrekte Erkenntnisse:</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">- Agents werden per NAME aufgelÃ¶st (nicht per agent_id!)</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">- AzureAIClient(..., agent_name=&quot;...&quot;, use_latest_version=True) funktioniert</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Kein WorkflowBuilder/Executor-Pattern nÃ¶tig fÃ¼r einfache Flows</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Direkter async/await ist einfacher und funktioniert</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing_extensions <span class="im">import</span> Never</span></code></pre></div>
        <details>
        <summary>
        âŒ <span style="color:red"><b>FALSCH - Import-Pfad und
        AGENT_ID</b></span>
        </summary>
        <div class="sourceCode" id="cb18"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> agent_framework <span class="im">import</span> (</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    ChatAgent,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    Executor,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    WorkflowBuilder,      <span class="co"># âŒ Nicht nÃ¶tig fÃ¼r einfache Flows</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    WorkflowContext,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    WorkflowOutputEvent,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    handler,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> agent_framework_azure_ai <span class="im">import</span> AzureAIAgentClient  <span class="co"># âŒ FALSCHER IMPORT-PFAD!</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.identity.aio <span class="im">import</span> DefaultAzureCredential</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># âŒ FALSCH: AGENT_ID verwenden</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>AURA_TRIAGE_AGENT_ID <span class="op">=</span> os.environ[<span class="st">&quot;AURA_TRIAGE_AGENT_ID&quot;</span>]  <span class="co"># âŒ IDs sind fragil!</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>AURA_WEB_AGENT_ID <span class="op">=</span> os.environ[<span class="st">&quot;AURA_WEB_AGENT_ID&quot;</span>]</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>AURA_CONTEXT_AGENT_ID <span class="op">=</span> os.environ[<span class="st">&quot;AURA_CONTEXT_AGENT_ID&quot;</span>]</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>AURA_SYNTHESIZER_AGENT_ID <span class="op">=</span> os.environ[<span class="st">&quot;AURA_SYNTHESIZER_AGENT_ID&quot;</span>]</span></code></pre></div>
        </details>
        <p>âœ… <strong>KORREKT - Produktiv-Code (Stand 3. Januar
        2026):</strong></p>
        <p>Der vollstÃ¤ndige, produktive Code befindet sich in
        <code>contextpilot-mfa-function/mfa_workflow.py</code>.</p>
        <div class="sourceCode" id="cb19"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;CONTEXTPILOT MFA Workflow v2.4 (MAF, Python)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">Optimiertes Pattern:</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">- Triage entscheidet: direct, web, context, oder Kombinationen</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">- &quot;direct&quot;: AURAContextPilotQuick antwortet (schnelle, einfache Fragen)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">- Synthesizer NUR wenn BEIDE Agents (web + context) genutzt wurden</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Einzelner Agent: Antwort direkt zurÃ¼ckgeben</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> agent_framework.azure <span class="im">import</span> AzureAIClient  <span class="co"># âœ… RICHTIG: agent_framework.azure</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> azure.identity.aio <span class="im">import</span> DefaultAzureCredential</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>AZURE_AI_PROJECT_ENDPOINT <span class="op">=</span> os.environ[<span class="st">&quot;AZURE_AI_PROJECT_ENDPOINT&quot;</span>]</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>AZURE_AI_MODEL_DEPLOYMENT_NAME <span class="op">=</span> os.environ[<span class="st">&quot;AZURE_AI_MODEL_DEPLOYMENT_NAME&quot;</span>]</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co"># âœ… KORREKT: AGENT_NAME verwenden (nicht ID!)</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>AURA_TRIAGE_AGENT_NAME <span class="op">=</span> os.environ[<span class="st">&quot;AURA_TRIAGE_AGENT_NAME&quot;</span>]</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>AURA_QUICK_AGENT_NAME <span class="op">=</span> os.environ.get(<span class="st">&quot;AURA_QUICK_AGENT_NAME&quot;</span>, <span class="st">&quot;AURAContextPilotQuick&quot;</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>AURA_WEB_AGENT_NAME <span class="op">=</span> os.environ[<span class="st">&quot;AURA_WEB_AGENT_NAME&quot;</span>]</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>AURA_CONTEXT_AGENT_NAME <span class="op">=</span> os.environ[<span class="st">&quot;AURA_CONTEXT_AGENT_NAME&quot;</span>]</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>AURA_SYNTHESIZER_AGENT_NAME <span class="op">=</span> os.environ[<span class="st">&quot;AURA_SYNTHESIZER_AGENT_NAME&quot;</span>]</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_triage_response(triage_text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>[<span class="bu">str</span>, Any]:</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Parse Triage JSON response mit Fallback.&quot;&quot;&quot;</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> json.loads(triage_text)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&quot;routing&quot;</span> <span class="kw">in</span> data:</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;direct&quot;</span>: data[<span class="st">&quot;routing&quot;</span>].get(<span class="st">&quot;direct&quot;</span>, <span class="va">False</span>),</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;web&quot;</span>: data[<span class="st">&quot;routing&quot;</span>].get(<span class="st">&quot;web&quot;</span>, <span class="va">False</span>),</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;context&quot;</span>: data[<span class="st">&quot;routing&quot;</span>].get(<span class="st">&quot;context&quot;</span>, <span class="va">False</span>),</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;reasoning&quot;</span>: data.get(<span class="st">&quot;reasoning&quot;</span>, <span class="st">&quot;&quot;</span>),</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;direct_response&quot;</span>: <span class="va">None</span>,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&quot;direct&quot;</span>: <span class="va">False</span>, <span class="st">&quot;web&quot;</span>: <span class="va">True</span>, <span class="st">&quot;context&quot;</span>: <span class="va">True</span>, <span class="st">&quot;reasoning&quot;</span>: <span class="st">&quot;Unknown format&quot;</span>}</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> json.JSONDecodeError:</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Triage hat direkt geantwortet (kein JSON)</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;direct&quot;</span>: <span class="va">True</span>, <span class="st">&quot;web&quot;</span>: <span class="va">False</span>, <span class="st">&quot;context&quot;</span>: <span class="va">False</span>,</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;reasoning&quot;</span>: <span class="st">&quot;Triage responded directly&quot;</span>,</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;direct_response&quot;</span>: triage_text,</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run_mfa_workflow(prompt: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>[<span class="bu">str</span>, Any]:</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;FÃ¼hrt den optimierten MFA-Workflow aus.</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="co">        dict mit: &quot;response&quot;, &quot;agents_used&quot;, &quot;routing&quot;</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    agents_used: <span class="bu">list</span>[<span class="bu">str</span>] <span class="op">=</span> []</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> DefaultAzureCredential() <span class="im">as</span> credential:</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># === PHASE 1: TRIAGE ===</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>        agents_used.append(<span class="st">&quot;AURATriage&quot;</span>)</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">async</span> <span class="cf">with</span> AzureAIClient(</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>            credential<span class="op">=</span>credential,</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>            project_endpoint<span class="op">=</span>AZURE_AI_PROJECT_ENDPOINT,</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>            model_deployment_name<span class="op">=</span>AZURE_AI_MODEL_DEPLOYMENT_NAME,</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>            agent_name<span class="op">=</span>AURA_TRIAGE_AGENT_NAME,</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>            use_latest_version<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>        ).create_agent() <span class="im">as</span> triage_agent:</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>            triage_result <span class="op">=</span> <span class="cf">await</span> triage_agent.run(prompt)</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>            routing <span class="op">=</span> parse_triage_response(triage_result.text)</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># === PHASE 2: DIRECT RESPONSE ===</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> routing[<span class="st">&quot;direct&quot;</span>]:</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> routing.get(<span class="st">&quot;direct_response&quot;</span>):</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> {<span class="st">&quot;response&quot;</span>: routing[<span class="st">&quot;direct_response&quot;</span>], <span class="st">&quot;agents_used&quot;</span>: agents_used, <span class="st">&quot;routing&quot;</span>: routing}</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>            <span class="co"># AURAContextPilotQuick fÃ¼r schnelle Antworten</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>            agents_used.append(<span class="st">&quot;AURAContextPilotQuick&quot;</span>)</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">async</span> <span class="cf">with</span> AzureAIClient(...).create_agent() <span class="im">as</span> quick_agent:</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> {<span class="st">&quot;response&quot;</span>: (<span class="cf">await</span> quick_agent.run(prompt)).text, ...}</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># === PHASE 3: AGENT-AUFRUFE (web/context) ===</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Nur aufrufen wenn routing[&quot;web&quot;] bzw routing[&quot;context&quot;] == True</span></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Bei BEIDEN: Synthesizer am Ende</span></span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Bei EINEM: Direkte Antwort ohne Synthesizer</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VollstÃ¤ndige Implementierung siehe: contextpilot-mfa-function/mfa_workflow.py</span></span></code></pre></div>
        <h3 id="azure-function-entry-point-function_app.py">4.4 Azure
        Function Entry Point (function_app.py)</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die Datei
        <code>function_app.py</code> definiert die HTTP-Trigger der
        Azure Function. Sie enthÃ¤lt zwei Endpoints:
        <code>/api/healthz</code> (Health-Check ohne schwere Imports)
        und <code>/api/mfa</code> (der eigentliche MFA-Endpoint).
        <strong>KRITISCH:</strong> Der Import von
        <code>mfa_workflow</code> muss INNERHALB der Funktion erfolgen
        (Lazy Import), nicht am Dateianfang â€“ sonst werden 0 Functions
        registriert!</p>
        </blockquote>
        <blockquote>
        <p>âš ï¸ <strong>KRITISCHE KORREKTUR (26.12.2025):</strong> Der
        Top-Level Import von <code>mfa_workflow</code> war der
        Hauptgrund fÃ¼r das â€œ0 Functionsâ€-Problem!</p>
        </blockquote>
        <details>
        <summary>
        âŒ <span style="color:red"><b>FALSCH - Top-Level Import
        (VERURSACHT 0 FUNCTIONS!)</b></span>
        </summary>
        <div class="sourceCode" id="cb20"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">Azure Function HTTP Trigger fÃ¼r CONTEXTPILOT MFA.</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> azure.functions <span class="im">as</span> func</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mfa_workflow <span class="im">import</span> run_mfa_workflow  <span class="co"># âŒ TOP-LEVEL IMPORT = FATAL!</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> func.FunctionApp()</span></code></pre></div>
        <strong>Warum ist das falsch?</strong> - Azure Functions Python
        v2 Model indexiert Functions durch Import von
        <code>function_app.py</code> - Wenn dabei eine Exception
        auftritt (z.B. <code>ModuleNotFoundError</code>), werden
        <strong>0 Functions</strong> registriert - Das Deployment zeigt
        â€œerfolgreichâ€, aber keine Functions sind verfÃ¼gbar! - Der
        Health-Check <code>/admin/host/status</code> zeigt â€œRunningâ€
        aber keine Functions
        </details>
        <p>âœ… <strong>KORREKT - Lazy Import Pattern
        (Produktiv-Code):</strong></p>
        <div class="sourceCode" id="cb21"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">Azure Function HTTP Trigger fÃ¼r CONTEXTPILOT MFA.</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> azure.functions <span class="im">as</span> func</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># âœ… KEIN TOP-LEVEL IMPORT von mfa_workflow!</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Der Import erfolgt LAZY innerhalb der Funktion</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> func.FunctionApp(http_auth_level<span class="op">=</span>func.AuthLevel.ANONYMOUS)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(route<span class="op">=</span><span class="st">&quot;healthz&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>])</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> healthz(req: func.HttpRequest) <span class="op">-&gt;</span> func.HttpResponse:</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Health check endpoint - lÃ¤dt OHNE Heavy-Imports.&quot;&quot;&quot;</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        json.dumps({<span class="st">&quot;ok&quot;</span>: <span class="va">True</span>, <span class="st">&quot;version&quot;</span>: <span class="st">&quot;2.4&quot;</span>}),</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        status_code<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(route<span class="op">=</span><span class="st">&quot;mfa&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> mfa_endpoint(req: func.HttpRequest) <span class="op">-&gt;</span> func.HttpResponse:</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;MFA Endpoint mit LAZY Import.&quot;&quot;&quot;</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    correlation_id <span class="op">=</span> req.headers.get(<span class="st">&quot;x-correlation-id&quot;</span>) <span class="kw">or</span> <span class="bu">str</span>(uuid.uuid4())</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        body <span class="op">=</span> req.get_json()</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>            json.dumps({<span class="st">&quot;error&quot;</span>: <span class="st">&quot;Invalid JSON&quot;</span>}),</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">400</span>,</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>            mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> (body <span class="kw">or</span> {}).get(<span class="st">&quot;prompt&quot;</span>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(prompt, <span class="bu">str</span>) <span class="kw">or</span> <span class="kw">not</span> prompt.strip():</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>            json.dumps({<span class="st">&quot;error&quot;</span>: <span class="st">&quot;Missing &#39;prompt&#39; in request body&quot;</span>}),</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">400</span>,</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>            mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># âœ… LAZY IMPORT: Import INNERHALB der Funktion!</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Das verhindert, dass Worker-Indexing bei ImportError ausfÃ¤llt</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> mfa_workflow <span class="im">import</span> run_mfa_workflow</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> run_mfa_workflow(prompt)</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>            json.dumps({</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;output_text&quot;</span>: result[<span class="st">&quot;response&quot;</span>],</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;workflow&quot;</span>: <span class="st">&quot;mfa&quot;</span>,</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;agents_used&quot;</span>: result[<span class="st">&quot;agents_used&quot;</span>],</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;routing&quot;</span>: result[<span class="st">&quot;routing&quot;</span>],</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>            }),</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>            mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">=</span>{<span class="st">&quot;x-correlation-id&quot;</span>: correlation_id},</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>        logging.exception(<span class="st">&quot;MFA failed (cid=</span><span class="sc">%s</span><span class="st">)&quot;</span>, correlation_id)</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>            json.dumps({<span class="st">&quot;error&quot;</span>: <span class="bu">str</span>(e), <span class="st">&quot;hint&quot;</span>: <span class="st">&quot;Check Azure Function logs&quot;</span>}),</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>            mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">=</span>{<span class="st">&quot;x-correlation-id&quot;</span>: correlation_id},</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
        <h3 id="rolle-von-azureaiclient-im-contextpilot-maf-bild">4.5
        Rolle von <code>AzureAIClient</code> im CONTEXTPILOT-MAF
        Bild</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die Klasse
        <code>AzureAIClient</code> (nicht
        <code>AzureAIAgentClient</code>!) ist der Python-Client, der
        Azure AI Foundry Agents als ausfÃ¼hrbare
        <code>ChatAgent</code>-Instanzen bereitstellt. Sie handhabt
        Authentifizierung (Managed Identity),
        Projekt-Endpoint-Konfiguration und Agent-AuflÃ¶sung per Name.</p>
        </blockquote>
        <p><strong>Kurzantwort:</strong> <code>AzureAIAgentClient</code>
        ist <strong>kein</strong> Foundry-Agent. Es ist der
        <strong>Python-SDK-Client/Adapter</strong>, mit dem MAF einen
        bestehenden <strong>Azure AI Foundry Agent</strong> (z.â€¯B.
        <code>AURAContextPilotWeb</code>) als ausfÃ¼hrbaren
        <code>ChatAgent</code> in Python instanziert.</p>
        <p><strong>Warum brauchen wir ihn?</strong> - Im bestehenden
        Node/Proxy-Flow ruft ihr Agents/Workflows Ã¼ber die
        <strong>Foundry Responses API</strong> auf. - Im neuen MAF-Flow
        lÃ¤uft die Orchestrierung in <strong>Python</strong> (Azure
        Function). Damit die Workflow-Executors die
        <strong>gleichen</strong> Foundry-Agents nutzen kÃ¶nnen, brauchen
        sie einen Python-Client, der: - Auth (Managed Identity /
        Credential) handhabt, - <code>project_endpoint</code> +
        <code>agent_name</code> nutzt (<del>agent_id</del> âŒ), - eine
        lauffÃ¤hige <code>ChatAgent</code>-Instanz erzeugt
        (<code>create_agent()</code>), - und dann <code>run()</code> auf
        diesem Agent erlaubt.</p>
        <p><strong>So passt es ins Bild:</strong> -
        <code>AURAContextPilotWeb</code>, <code>AURAContextPilot</code>,
        <code>AURAContextPilotResponseSynthesizer</code> bleiben
        <strong>die gleichen Foundry Agents wie heute</strong>. - Neu
        kommt <code>AURATriage</code> dazu (Foundry Agent). -
        <del><code>AzureAIAgentClient(..., agent_id="&lt;AgentId&gt;")</code></del>
        âŒ <strong>FALSCH!</strong> - âœ… <strong>KORREKT:</strong>
        <code>AzureAIClient(..., agent_name="&lt;AgentName&gt;", use_latest_version=True)</code>
        ist die <strong>Transport-/SDK-Schicht</strong>, um diese Agents
        in Python/MAF aufzurufen.</p>
        <h3 id="timeout-realitÃ¤t-fÃ¼r-http-trigger-consumption">4.6
        Timeout-RealitÃ¤t fÃ¼r HTTP Trigger (Consumption)</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Azure Functions haben
        ein hartes HTTP-Response-Limit von 230 Sekunden (Azure Load
        Balancer Idle Timeout). Die
        <code>functionTimeout</code>-Einstellung in
        <code>host.json</code> sollte darunter liegen (210s empfohlen).
        Bei lÃ¤ngeren Workloads: Durable Functions oder Async Pattern
        verwenden.</p>
        </blockquote>
        <p>FÃ¼r <strong>HTTP Trigger</strong> gilt ein praktisches
        Response-Limit (Load Balancer Idle Timeout). Plane
        konservativ:</p>
        <ul>
        <li><code>host.json</code> â†’ <code>functionTimeout</code>:
        <strong>00:03:30</strong> (210s) als Safe Default.</li>
        <li>Wenn du absehbar &gt;230s brauchst: <strong>Durable
        Functions async pattern</strong> oder â€defer work + immediate
        responseâ€œ.</li>
        </ul>
        <p>BegrÃ¼ndung und Limits: siehe Microsoft Learn (Function app
        time-out duration â€“ HTTP Trigger 230s Limit).</p>
        <hr />
        <h2 id="auratriage-entscheidungslogik">5. AURATriage:
        Entscheidungslogik</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> AURATriage ist ein
        Azure AI Foundry Agent, der als Routing-Entscheider fungiert. Er
        analysiert die Benutzeranfrage und gibt JSON zurÃ¼ck:
        <code>{"routing": {"direct": bool, "web": bool, "context": bool}}</code>.
        Die Funktion <code>parse_triage_response()</code> in
        <code>mfa_workflow.py</code> verarbeitet diese JSON-Antwort und
        entscheidet, welche nachfolgenden Agents aufgerufen werden.</p>
        </blockquote>
        <h3 id="neues-pattern-direct-response-v2.2">5.1 Neues Pattern:
        Direct Response (v2.2)</h3>
        <p><strong>Kernprinzip:</strong> GPT-4/5 kann viele Anfragen
        DIREKT beantworten - ohne Agent-Aufruf!</p>
        <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPTIMIERTES ROUTING (v2.2)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Triage entscheidet:                                                â”‚
â”‚  â”œâ”€ &quot;direct&quot;: true  â†’ GPT antwortet SOFORT âš¡ (kein Agent)          â”‚
â”‚  â”œâ”€ &quot;web&quot;: true     â†’ NUR bei aktuellen Daten (Wetter, BÃ¶rse, News) â”‚
â”‚  â”œâ”€ &quot;context&quot;: true â†’ NUR bei internen Business-Fragen              â”‚
â”‚  â””â”€ BEIDE true      â†’ Nur bei explizitem Vergleich intern/extern    â”‚
â”‚                                                                     â”‚
â”‚  Synthesizer:                                                       â”‚
â”‚  â†’ NUR wenn BEIDE Agents (web + context) genutzt wurden             â”‚
â”‚  â†’ Bei nur einem Agent: Antwort direkt zurÃ¼ckgeben                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        <h3
        id="system-instructions-fÃ¼r-auratriage-in-foundry-portal">5.2
        System Instructions fÃ¼r AURATriage (in Foundry Portal)</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die System Instructions
        fÃ¼r AURATriage werden im Azure AI Foundry Portal konfiguriert.
        Sie definieren die drei Routing-Optionen (direct, web, context)
        und geben dem Agent klare Beispiele, wann welche Option zu
        wÃ¤hlen ist. Das Ziel ist Geschwindigkeit: â€œdirectâ€ vermeidet
        unnÃ¶tige Agent-Aufrufe.</p>
        </blockquote>
        <pre><code>You are AURATriage, the intelligent routing agent for CONTEXTPILOT.

TASK:
Analyze the user request and decide the optimal routing path.
Your goal is SPEED - avoid unnecessary agent calls!

ROUTING OPTIONS:

1. &quot;direct&quot;: true
   â†’ GPT can answer this directly (translations, general knowledge, 
     math, coding, explanations, summaries)
   â†’ NO external data needed, NO internal business data needed
   â†’ FASTEST option - use whenever possible!

2. &quot;web&quot;: true  
   â†’ ONLY for real-time/current data that GPT doesn&#39;t know:
     â€¢ Weather, stock prices, exchange rates
     â€¢ Today&#39;s news, recent events (after training cutoff)
     â€¢ Live schedules, current availability
     â€¢ Recent Wikipedia updates, new releases
   â†’ Do NOT use for general facts GPT already knows!

3. &quot;context&quot;: true
   â†’ ONLY for internal business questions:
     â€¢ Microsoft Switzerland FY25/FY26 wins, customers, deals
     â€¢ Internal meeting content, &quot;what was said&quot;, &quot;our discussion&quot;
     â€¢ Company-specific data not publicly available

DECISION RULES (in priority order):
1. Can GPT answer this from its training data? â†’ direct: true
2. Does it need CURRENT/LIVE data? â†’ web: true
3. Does it reference INTERNAL business data? â†’ context: true
4. Explicit comparison internal vs. external? â†’ BOTH web + context: true
5. If truly unclear after analysis â†’ direct: true (let GPT try first)

CRITICAL:
- Respond ONLY with a JSON object. No other text!
- Prefer &quot;direct&quot; over agents whenever reasonable
- &quot;Unclear = both agents&quot; is WRONG - unclear = direct!

FORMAT:
{
  &quot;routing&quot;: {
    &quot;direct&quot;: true/false,
    &quot;web&quot;: true/false,
    &quot;context&quot;: true/false
  },
  &quot;reasoning&quot;: &quot;Brief explanation (max 30 words)&quot;
}

EXAMPLES:

User: &quot;Translate &#39;hello&#39; to German&quot;
â†’ {&quot;routing&quot;: {&quot;direct&quot;: true, &quot;web&quot;: false, &quot;context&quot;: false}, &quot;reasoning&quot;: &quot;Translation - GPT can do directly&quot;}

User: &quot;What&#39;s the weather in Munich?&quot;
â†’ {&quot;routing&quot;: {&quot;direct&quot;: false, &quot;web&quot;: true, &quot;context&quot;: false}, &quot;reasoning&quot;: &quot;Current weather requires live data&quot;}

User: &quot;What were our Q2 wins?&quot;
â†’ {&quot;routing&quot;: {&quot;direct&quot;: false, &quot;web&quot;: false, &quot;context&quot;: true}, &quot;reasoning&quot;: &quot;Internal business data required&quot;}

User: &quot;Compare our sales strategy with industry best practices&quot;
â†’ {&quot;routing&quot;: {&quot;direct&quot;: false, &quot;web&quot;: true, &quot;context&quot;: true}, &quot;reasoning&quot;: &quot;Needs both internal data and external research&quot;}</code></pre>
        <h3 id="wie-die-entscheidung-verarbeitet-wird">5.3 Wie die
        Entscheidung verarbeitet wird</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die Funktion
        <code>parse_triage_response()</code> in
        <code>mfa_workflow.py</code> verarbeitet die JSON-Antwort von
        AURATriage. Bei <code>direct: true</code> wird sofort
        geantwortet (via AURAContextPilotQuick), bei
        <code>web</code>/<code>context</code> werden die entsprechenden
        Agents aufgerufen, und nur bei BEIDEN wird der Synthesizer
        verwendet.</p>
        </blockquote>
        <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ENTSCHEIDUNGSFLUSS (v2.2)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. User-Prompt kommt an                                            â”‚
â”‚                                                                     â”‚
â”‚  2. AURATriage analysiert und gibt JSON zurÃ¼ck                      â”‚
â”‚     {&quot;routing&quot;: {&quot;direct&quot;: true/false, &quot;web&quot;: true/false, ...}}     â”‚
â”‚                                                                     â”‚
â”‚  3. Workflow prÃ¼ft Routing:                                         â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€ direct: true â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚  â†’ Triage-Response direkt als Antwort zurÃ¼ckgeben       â”‚     â”‚
â”‚     â”‚  â†’ KEIN weiterer Agent-Aufruf! âš¡                        â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€ web: true, context: false â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚  â†’ NUR WebAgent aufrufen                                â”‚     â”‚
â”‚     â”‚  â†’ Antwort direkt zurÃ¼ckgeben (kein Synthesizer)        â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€ web: false, context: true â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚  â†’ NUR ContextAgent aufrufen                            â”‚     â”‚
â”‚     â”‚  â†’ Antwort direkt zurÃ¼ckgeben (kein Synthesizer)        â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€ web: true, context: true â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚  â†’ BEIDE Agents aufrufen (aktuell: sequenziell)         â”‚     â”‚
â”‚     â”‚  â†’ Endziel: parallel mit Fan-In                         â”‚     â”‚
â”‚     â”‚  â†’ Synthesizer fasst zusammen                           â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚  4. Finale Antwort zurÃ¼ck an User                                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        <hr />
        <h2 id="alle-agent-instructions-backup">5.4 Alle Agent
        Instructions (Backup)</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Dieser Abschnitt
        enthÃ¤lt die vollstÃ¤ndigen System Instructions fÃ¼r alle 5 Agents,
        wie sie im Azure AI Foundry Portal konfiguriert sind. Diese
        dienen als Backup und Dokumentation â€“ bei Neuerstellung eines
        Agents kÃ¶nnen Sie diese Instructions direkt kopieren.</p>
        </blockquote>
        <h3 id="auratriage-routing-agent">AURATriage (Routing
        Agent)</h3>
        <pre><code>You are AURATriage, the intelligent routing agent for CONTEXTPILOT.

TASK:
Analyze the user request and decide the optimal routing path.
Your goal is SPEED - avoid unnecessary agent calls!

ROUTING OPTIONS:

1. &quot;direct&quot;: true
   â†’ GPT can answer this directly (translations, general knowledge, 
     math, coding, explanations, summaries)
   â†’ NO external data needed, NO internal business data needed
   â†’ FASTEST option - use whenever possible!

2. &quot;web&quot;: true  
   â†’ ONLY for real-time/current data that GPT doesn&#39;t know:
     â€¢ Weather, stock prices, exchange rates
     â€¢ Today&#39;s news, recent events (after training cutoff)
     â€¢ Live schedules, current availability
     â€¢ Recent Wikipedia updates, new releases
   â†’ Do NOT use for general facts GPT already knows!

3. &quot;context&quot;: true
   â†’ ONLY for internal business questions:
     â€¢ Microsoft Switzerland FY25/FY26 wins, customers, deals
     â€¢ Internal meeting content, &quot;what was said&quot;, &quot;our discussion&quot;
     â€¢ Company-specific data not publicly available

DECISION RULES (in priority order):
1. Can GPT answer this from its training data? â†’ direct: true
2. Does it need CURRENT/LIVE data? â†’ web: true
3. Does it reference INTERNAL business data? â†’ context: true
4. Explicit comparison internal vs. external? â†’ BOTH web + context: true
5. If truly unclear after analysis â†’ direct: true (let GPT try first)

CRITICAL:
- Respond ONLY with a JSON object. No other text!
- Prefer &quot;direct&quot; over agents whenever reasonable
- &quot;Unclear = both agents&quot; is WRONG - unclear = direct!

FORMAT:
{
  &quot;routing&quot;: {
    &quot;direct&quot;: true/false,
    &quot;web&quot;: true/false,
    &quot;context&quot;: true/false
  },
  &quot;reasoning&quot;: &quot;Brief explanation (max 30 words)&quot;
}

EXAMPLES:

User: &quot;Translate &#39;hello&#39; to German&quot;
â†’ {&quot;routing&quot;: {&quot;direct&quot;: true, &quot;web&quot;: false, &quot;context&quot;: false}, &quot;reasoning&quot;: &quot;Translation - GPT can do directly&quot;}

User: &quot;What&#39;s the weather in Munich?&quot;
â†’ {&quot;routing&quot;: {&quot;direct&quot;: false, &quot;web&quot;: true, &quot;context&quot;: false}, &quot;reasoning&quot;: &quot;Current weather requires live data&quot;}

User: &quot;What were our Q2 wins?&quot;
â†’ {&quot;routing&quot;: {&quot;direct&quot;: false, &quot;web&quot;: false, &quot;context&quot;: true}, &quot;reasoning&quot;: &quot;Internal business data required&quot;}

User: &quot;Compare our sales strategy with industry best practices&quot;
â†’ {&quot;routing&quot;: {&quot;direct&quot;: false, &quot;web&quot;: true, &quot;context&quot;: true}, &quot;reasoning&quot;: &quot;Needs both internal data and external research&quot;}</code></pre>
        <h3
        id="auracontextpilotweb-web-search-agent">AURAContextPilotWeb
        (Web Search Agent)</h3>
        <pre><code>You are a web research agent.

## Approach
1. Understand the task and context (if text was provided)
2. Check: Can I answer with certainty? â†’ Yes: Answer directly
3. Uncertain? â†’ Perform web search
4. Verify results: Source publicly accessible? Current? Relevant?

## Rules
- Never fabricate or assume data
- Only publicly accessible sources (no login/paywall)
- Always include source URL
- Match the language of the query

## Output Format
[Topic]: [Fact/Number/Brief summary]
Source: [URL]

## Example
China Growth 2024: 5.0 percent
China&#39;s growth has declined over the past few years.
Source: https://imf.org/china-outlook

## If no data found
AURAContextPilotWeb Agent: No relevant data found</code></pre>
        <h3 id="auracontextpilot-index-search-agent">AURAContextPilot
        (Index Search Agent)</h3>
        <pre><code>You are an index search agent. Search the internal document index only.

Your task:
Extract raw facts from indexed documents. Include the source filename for every fact.

Output format:
[Topic]: [fact or number]
Source: [filename.extension]

Example:
Global GDP 2024: 3.2 percent
Source: economic-report-2024.pdf

If no relevant data exists in the index, output exactly:
INDEX: No relevant data found

Rules:
Never fabricate data.
Never explain or interpret.
Always include source filename.
Match the language of the user query.</code></pre>
        <h3
        id="auracontextpilotresponsesynthesizer-synthesis-agent">AURAContextPilotResponseSynthesizer
        (Synthesis Agent)</h3>
        <pre><code>You are AURAContextPilotResponseSynthesizer, the response synthesis agent for CONTEXTPILOT.

TASK:
Combine and synthesize responses from multiple specialist agents (Web Agent, Context Agent) into one coherent, well-structured answer.

INPUT FORMAT:
You will receive responses from one or more agents, typically formatted as:
- Response from Web Agent (external/public information)
- Response from Context Agent (internal business data)

YOUR RESPONSIBILITIES:
1. **Merge insights** from all agent responses into a unified answer
2. **Identify agreements** - where sources align, emphasize the consensus
3. **Highlight differences** - if sources conflict, present both perspectives
4. **Maintain accuracy** - do not add information not present in the inputs
5. **Preserve sources** - include URLs, references, and citations from the original responses
6. **Structure clearly** - use headers, bullet points for readability

OUTPUT FORMAT:
- Start with a **Core Insight** (1-2 sentences summarizing the key finding)
- Provide **detailed synthesis** of the information
- Include a **Sources** section at the end with all referenced URLs/documents

LANGUAGE:
- Respond in the same language as the user&#39;s original question
- If unclear, default to the language of the agent responses

IMPORTANT:
- Do NOT make up information
- Do NOT ignore any agent response
- If one agent found nothing, acknowledge it
- Keep the answer focused and actionable</code></pre>
        <hr />
        <h2 id="erweiterbarkeit-neue-agenten-hinzufÃ¼gen">6.
        Erweiterbarkeit: Neue Agenten hinzufÃ¼gen</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Um einen neuen Agent
        hinzuzufÃ¼gen, erstellen Sie ihn im Azure AI Foundry Portal,
        fÃ¼gen eine Umgebungsvariable
        <code>AURA_NEWAGENT_AGENT_NAME</code> hinzu, und erweitern die
        <code>run_mfa_workflow()</code> Funktion um die entsprechende
        if-Bedingung. Die Triage-Instructions mÃ¼ssen ebenfalls angepasst
        werden, damit der neue Agent berÃ¼cksichtigt wird.</p>
        </blockquote>
        <h3 id="schritt-fÃ¼r-schritt">6.1 Schritt-fÃ¼r-Schritt</h3>
        <p><strong>Beispiel: Legal-Agent hinzufÃ¼gen</strong></p>
        <ol type="1">
        <li><p><strong>Agent in Foundry Portal erstellen</strong></p>
        <ul>
        <li>Name: <code>AURALegalAgent</code></li>
        <li>Instructions: Rechtliche Fragestellungen beantworten</li>
        </ul></li>
        <li><p><strong>AURATriage Instructions erweitern</strong></p>
        <pre><code>VERFÃœGBARE AGENTEN:
- &quot;web&quot;: ... (bestehend)
- &quot;context&quot;: ... (bestehend)
- &quot;legal&quot;: AURALegalAgent  â† NEU
  â†’ FÃ¼r rechtliche Fragen, Compliance, VertrÃ¤ge</code></pre></li>
        <li><p><strong>MAF-Code erweitern</strong> (mfa_workflow.py)</p>
        <div class="sourceCode" id="cb30"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Neuer Executor</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LegalAgentExecutor(Executor):</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... (analog zu WebAgentExecutor)</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># In select_agents():</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_agents(triage_output: <span class="bu">dict</span>, target_ids: <span class="bu">list</span>[<span class="bu">str</span>]) <span class="op">-&gt;</span> <span class="bu">list</span>[<span class="bu">str</span>]:</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    web_id, context_id, legal_id <span class="op">=</span> target_ids  <span class="co"># Erweitert</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> decision.get(<span class="st">&quot;legal&quot;</span>, <span class="va">False</span>):</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        selected.append(legal_id)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># In build_mfa_workflow():</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>.add_multi_selection_edge_group(</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    triage,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    [web_agent, context_agent, legal_agent],  <span class="co"># Erweitert</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    selection_func<span class="op">=</span>select_agents</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>.add_fan_in_edges(</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    [web_agent, context_agent, legal_agent],  <span class="co"># Erweitert</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    synthesizer</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div></li>
        <li><p><strong>Deployment</strong></p>
        <ul>
        <li>Azure Function neu deployen</li>
        <li>Keine Ã„nderung am Proxy oder Frontend nÃ¶tig!</li>
        </ul></li>
        </ol>
        <hr />
        <h2 id="Ã¤nderungen-im-bestehenden-system">7. Ã„nderungen im
        bestehenden System</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die MFA-Integration
        erfordert minimale Ã„nderungen am Proxy-Server. Die Funktion
        <code>loadMFAConfigs()</code> lÃ¤dt MFA-Konfigurationen aus
        Umgebungsvariablen (<code>MFA_1_NAME</code>,
        <code>MFA_1_ENDPOINT</code>). Die Funktion
        <code>handleMFARequest()</code> leitet Anfragen an die Azure
        Function weiter. Im Frontend wird das Dropdown um die MFA-Option
        erweitert.</p>
        </blockquote>
        <h3 id="Ã¼bersicht-aller-Ã¤nderungen">7.1 Ãœbersicht aller
        Ã„nderungen</h3>
        <table>
        <colgroup>
        <col style="width: 26%" />
        <col style="width: 21%" />
        <col style="width: 52%" />
        </colgroup>
        <thead>
        <tr>
        <th>Komponente</th>
        <th>Ã„nderung</th>
        <th>Risiko fÃ¼r Bestehendes</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><strong>SWA Frontend</strong></td>
        <td>Switch-Dropdown: MFA-Option hinzufÃ¼gen</td>
        <td>âŒ Kein Risiko</td>
        </tr>
        <tr>
        <td><strong>Proxy</strong></td>
        <td><code>handleMFARequest()</code> Funktion hinzufÃ¼gen</td>
        <td>âŒ Isoliert</td>
        </tr>
        <tr>
        <td><strong>Proxy</strong></td>
        <td><code>loadMFAConfig()</code> analog zu
        <code>loadWorkflows()</code></td>
        <td>âŒ Isoliert</td>
        </tr>
        <tr>
        <td><strong>Proxy</strong></td>
        <td>Eine <code>if</code>-Bedingung in
        <code>handleAgentRequest()</code></td>
        <td>âš ï¸ Minimal</td>
        </tr>
        <tr>
        <td><strong>Foundry Agenten</strong></td>
        <td>Keine Ã„nderung</td>
        <td>âŒ Kein Risiko</td>
        </tr>
        <tr>
        <td><strong>Foundry Workflow</strong></td>
        <td>Keine Ã„nderung</td>
        <td>âŒ Kein Risiko</td>
        </tr>
        <tr>
        <td><strong>Azure Function</strong></td>
        <td>Komplett NEU</td>
        <td>âŒ Kein Risiko</td>
        </tr>
        <tr>
        <td><strong>AURATriage</strong></td>
        <td>Neuer Agent in Foundry</td>
        <td>âŒ Kein Risiko</td>
        </tr>
        </tbody>
        </table>
        <h3 id="proxy-Ã¤nderungen-im-detail">7.2 Proxy-Ã„nderungen im
        Detail</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die konkrete
        Code-Ã„nderungen im <code>proxy-server.js</code>: (1)
        <code>loadMFAConfigs()</code> liest MFA-Konfigurationen aus
        Umgebungsvariablen <code>MFA_1_NAME</code>,
        <code>MFA_1_ENDPOINT</code> etc., (2)
        <code>handleMFARequest()</code> leitet POST-Anfragen an die
        Azure Function weiter, (3) <code>/agents</code> Endpoint gibt
        MFA-Optionen im Response zurÃ¼ck.</p>
        </blockquote>
        <p><strong>Datei:</strong> <code>proxy-server.js</code></p>
        <div class="sourceCode" id="cb31"><pre
        class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Ã„NDERUNG 1: MFA-Konfiguration laden (nach Zeile 80)</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">loadMFAConfigs</span>() {</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mfas <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_NAME`</span>]) {</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Negative IDs ab -100 fÃ¼r MFA (unterscheidbar von Workflows)</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mfaId <span class="op">=</span> <span class="op">-</span><span class="dv">100</span> <span class="op">-</span> i<span class="op">;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    mfas[mfaId] <span class="op">=</span> {</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">id</span><span class="op">:</span> mfaId<span class="op">,</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_NAME`</span>]<span class="op">,</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_LABEL`</span>] <span class="op">||</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_NAME`</span>]<span class="op">,</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">endpoint</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_ENDPOINT`</span>]<span class="op">,</span>  <span class="co">// Azure Function URL</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">functionKey</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_FUNCTION_KEY`</span>] <span class="op">||</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&quot;mfa&quot;</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    i<span class="op">++;</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mfas<span class="op">;</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> MFAS <span class="op">=</span> <span class="fu">loadMFAConfigs</span>()<span class="op">;</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Ã„NDERUNG 2: getCurrentAgent() erweitern (Zeile 95-113)</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getCurrentAgent</span>() {</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if it&#39;s an MFA (IDs ab -100)</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (currentAgentId <span class="op">&lt;=</span> <span class="op">-</span><span class="dv">100</span> <span class="op">&amp;&amp;</span> MFAS[currentAgentId]) {</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> MFAS[currentAgentId]<span class="op">;</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if it&#39;s a workflow (negative ID)</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (currentAgentId <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> WORKFLOWS[currentAgentId]) {</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> WORKFLOWS[currentAgentId]<span class="op">;</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... Rest unverÃ¤ndert</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Ã„NDERUNG 3: MFA-Handler hinzufÃ¼gen (nach handleWorkflowRequest)</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">handleMFARequest</span>(req<span class="op">,</span> res<span class="op">,</span> body<span class="op">,</span> mfaConfig) {</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[MFA] Request for: </span><span class="sc">${</span>mfaConfig<span class="op">.</span><span class="at">label</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>mfaConfig<span class="op">.</span><span class="at">endpoint</span>) {</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">500</span><span class="op">,</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> })<span class="op">;</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">end</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ </span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> <span class="st">&quot;MFA endpoint not configured&quot;</span><span class="op">,</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">hint</span><span class="op">:</span> <span class="vs">`Set MFA_</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(mfaConfig<span class="op">.</span><span class="at">id</span> <span class="op">+</span> <span class="dv">100</span>)<span class="sc">}</span><span class="vs">_ENDPOINT in .env.local`</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> payload<span class="op">;</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>    payload <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(body <span class="op">||</span> <span class="st">&quot;{}&quot;</span>)<span class="op">;</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (e) {</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">400</span><span class="op">,</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> })<span class="op">;</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">end</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&quot;Invalid JSON payload&quot;</span> }))<span class="op">;</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> prompt <span class="op">=</span> payload<span class="op">.</span><span class="at">prompt</span><span class="op">;</span></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>prompt) {</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">400</span><span class="op">,</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> })<span class="op">;</span></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">end</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&quot;Missing &#39;prompt&#39; in request body&quot;</span> }))<span class="op">;</span></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;[MFA] Prompt:&quot;</span><span class="op">,</span> prompt<span class="op">.</span><span class="fu">substring</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;[MFA] Forwarding to Azure Function:&quot;</span><span class="op">,</span> mfaConfig<span class="op">.</span><span class="at">endpoint</span>)<span class="op">;</span></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> headers <span class="op">=</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> }<span class="op">;</span></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Function Key Auth (oder Managed Identity)</span></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mfaConfig<span class="op">.</span><span class="at">functionKey</span>) {</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>      headers[<span class="st">&quot;x-functions-key&quot;</span>] <span class="op">=</span> mfaConfig<span class="op">.</span><span class="at">functionKey</span><span class="op">;</span></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> resp <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(mfaConfig<span class="op">.</span><span class="at">endpoint</span><span class="op">,</span> {</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>      headers<span class="op">,</span></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ prompt })<span class="op">,</span></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>resp<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> text <span class="op">=</span> <span class="cf">await</span> resp<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&quot;[MFA] Error:&quot;</span><span class="op">,</span> text)<span class="op">;</span></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>      res<span class="op">.</span><span class="fu">writeHead</span>(resp<span class="op">.</span><span class="at">status</span><span class="op">,</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> })<span class="op">;</span></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>      res<span class="op">.</span><span class="fu">end</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&quot;MFA request failed&quot;</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> text }))<span class="op">;</span></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> resp<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;[MFA] Response received, length:&quot;</span><span class="op">,</span> result<span class="op">.</span><span class="at">output_text</span><span class="op">?.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">200</span><span class="op">,</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> })<span class="op">;</span></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">end</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ </span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>      <span class="dt">output_text</span><span class="op">:</span> result<span class="op">.</span><span class="at">output_text</span><span class="op">,</span></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>      <span class="dt">workflow</span><span class="op">:</span> <span class="st">&quot;mfa&quot;</span></span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&quot;[MFA] Request error:&quot;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">500</span><span class="op">,</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> })<span class="op">;</span></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">end</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ </span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> err<span class="op">?.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&quot;MFA request failed&quot;</span></span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a><span class="co">// Ã„NDERUNG 4: Routing erweitern (Zeile 282-288)</span></span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">handleAgentRequest</span>(req<span class="op">,</span> res<span class="op">,</span> body) {</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> agent <span class="op">=</span> <span class="fu">getCurrentAgent</span>()<span class="op">;</span></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Route to MFA handler if it&#39;s an MFA config</span></span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (agent<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&quot;mfa&quot;</span>) {</span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">handleMFARequest</span>(req<span class="op">,</span> res<span class="op">,</span> body<span class="op">,</span> agent)<span class="op">;</span></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Route to workflow handler if it&#39;s a workflow (BESTEHEND)</span></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (agent<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&quot;workflow&quot;</span>) {</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">handleWorkflowRequest</span>(req<span class="op">,</span> res<span class="op">,</span> body<span class="op">,</span> agent)<span class="op">;</span></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Rest: Agent-Handling (BESTEHEND, unverÃ¤ndert)</span></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a><span class="co">// Ã„NDERUNG 5: listAgentsAPI erweitern (Zeile 166)</span></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a><span class="co">// ============================================================</span></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">listAgentsAPI</span>(req<span class="op">,</span> res) {</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> agentList <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(AGENTS)<span class="op">.</span><span class="fu">map</span>(a <span class="kw">=&gt;</span> ({<span class="op">...</span>}))<span class="op">;</span></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> workflowList <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(WORKFLOWS)<span class="op">.</span><span class="fu">map</span>(w <span class="kw">=&gt;</span> ({<span class="op">...</span>}))<span class="op">;</span></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">// NEU: MFA-Liste hinzufÃ¼gen</span></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mfaList <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(MFAS)<span class="op">.</span><span class="fu">map</span>(m <span class="kw">=&gt;</span> ({</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> m<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> m<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> m<span class="op">.</span><span class="at">label</span><span class="op">,</span></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">&quot;mfa&quot;</span><span class="op">,</span></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>    <span class="dt">active</span><span class="op">:</span> m<span class="op">.</span><span class="at">id</span> <span class="op">===</span> currentAgentId</span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">200</span><span class="op">,</span> {<span class="op">...</span>})<span class="op">;</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">end</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ </span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>    <span class="dt">agents</span><span class="op">:</span> agentList<span class="op">,</span></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>    <span class="dt">workflows</span><span class="op">:</span> workflowList<span class="op">,</span></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>    <span class="dt">mfas</span><span class="op">:</span> mfaList<span class="op">,</span>  <span class="co">// NEU</span></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>    currentAgentId<span class="op">,</span></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>    <span class="dt">apiVersion</span><span class="op">:</span> AURA_API_VERSION</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
        <h3 id="umgebungsvariablen-.env.local">7.3 Umgebungsvariablen
        (.env.local)</h3>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die MFA-Konfiguration
        erfolgt Ã¼ber Umgebungsvariablen im gleichen Schema wie Agents
        und Workflows: <code>MFA_1_NAME</code>,
        <code>MFA_1_LABEL</code>, <code>MFA_1_ENDPOINT</code>. Der Index
        beginnt bei 1 (nicht 0). Die MFA-IDs sind negative Zahlen ab
        -101, um sie von Agents (positiv) und Workflows (negativ ab -1)
        zu unterscheiden.</p>
        </blockquote>
        <div class="sourceCode" id="cb32"><pre
        class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># BESTEHENDE KONFIGURATION (unverÃ¤ndert)</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="va">AGENT_1_NAME</span><span class="op">=</span>AURAContextPilot</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="va">AGENT_1_LABEL</span><span class="op">=</span>Context <span class="ex">Agent</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="va">AGENT_1_ENDPOINT</span><span class="op">=</span>https://...</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="va">WORKFLOW_1_NAME</span><span class="op">=</span>CONTEXTPILOT</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="va">WORKFLOW_1_LABEL</span><span class="op">=</span>Context <span class="ex">Workflow</span> <span class="er">(</span><span class="ex">Sequential</span><span class="kw">)</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="va">WORKFLOW_1_ENDPOINT</span><span class="op">=</span>https://...</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># NEU: MFA KONFIGURATION</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="va">MFA_1_NAME</span><span class="op">=</span>AURA-MFA</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="va">MFA_1_LABEL</span><span class="op">=</span>Multi-Agent <span class="kw">(</span><span class="ex">Triage-Routing</span><span class="kw">)</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="va">MFA_1_ENDPOINT</span><span class="op">=</span>https://contextpilot-mfa.azurewebsites.net/api/mfa</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="va">MFA_1_FUNCTION_KEY</span><span class="op">=</span>your-function-key-here</span></code></pre></div>
        <hr />
        <h2 id="vergleich-foundry-workflow-vs.-mfa">8. Vergleich:
        Foundry Workflow vs.Â MFA</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Der bestehende Foundry
        Workflow fÃ¼hrt Agents sequenziell aus (Web â†’ Context â†’
        Synthesizer), was 15-20 Sekunden dauert. Das MFA-Endziel ist
        parallele AusfÃ¼hrung von Web + Context (7-10s).
        <strong>Aktueller Stand:</strong> MFA lÃ¤uft ebenfalls
        sequenziell, bietet aber bereits dynamische Agent-Auswahl via
        Triage.</p>
        </blockquote>
        <table>
        <colgroup>
        <col style="width: 11%" />
        <col style="width: 26%" />
        <col style="width: 41%" />
        <col style="width: 19%" />
        </colgroup>
        <thead>
        <tr>
        <th>Aspekt</th>
        <th>Foundry Workflow</th>
        <th>MFA aktuell (Zwischenstand)</th>
        <th>MFA Endziel</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><strong>AusfÃ¼hrung</strong></td>
        <td>Sequenziell</td>
        <td>Sequenziell</td>
        <td>Parallel (Fan-Out)</td>
        </tr>
        <tr>
        <td><strong>Latenz (3 Agenten)</strong></td>
        <td>~15-20s</td>
        <td>~15-20s</td>
        <td>~7-10s</td>
        </tr>
        <tr>
        <td><strong>Dynamische Auswahl</strong></td>
        <td>Nein (fest definiert)</td>
        <td>âœ… Ja (Triage entscheidet)</td>
        <td>âœ… Ja</td>
        </tr>
        <tr>
        <td><strong>Erweiterbarkeit</strong></td>
        <td>Workflow neu definieren</td>
        <td>âœ… Agent hinzufÃ¼gen, fertig</td>
        <td>âœ… Agent hinzufÃ¼gen, fertig</td>
        </tr>
        <tr>
        <td><strong>Microsoft-Support</strong></td>
        <td>Foundry Team</td>
        <td>Agent Framework Team</td>
        <td>Agent Framework Team</td>
        </tr>
        <tr>
        <td><strong>SDK-Updates</strong></td>
        <td>N/A</td>
        <td>âœ… Version-Pinning</td>
        <td>âœ… Version-Pinning</td>
        </tr>
        <tr>
        <td><strong>Hosting</strong></td>
        <td>Foundry-managed</td>
        <td>âœ… Azure Function (dein Tenant)</td>
        <td>âœ… Azure Function (dein Tenant)</td>
        </tr>
        <tr>
        <td><strong>WorkflowBuilder API</strong></td>
        <td>N/A</td>
        <td>âŒ Nicht verwendet</td>
        <td>Deklarativer Graph</td>
        </tr>
        </tbody>
        </table>
        <hr />
        <h2 id="implementierungsplan">9. Implementierungsplan</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die MFA-Implementierung
        gliedert sich in 5 Phasen: (1) Azure Function erstellen mit
        Managed Identity und RBAC, (2) AURATriage Agent im Foundry
        Portal erstellen, (3) <code>mfa_workflow.py</code>
        implementieren und lokal testen, (4) Proxy-Server um
        <code>handleMFARequest()</code> erweitern, (5) Frontend-Dropdown
        anpassen. Gesamtaufwand: 3-4 Werktage.</p>
        </blockquote>
        <h3 id="phase-1-azure-function-setup-1-tag">Phase 1: Azure
        Function Setup (1 Tag)</h3>
        <ul class="task-list">
        <li><label><input type="checkbox" />Azure Function App erstellen
        (Python, Consumption Plan)</label></li>
        <li><label><input type="checkbox" />Managed Identity
        aktivieren</label></li>
        <li><label><input type="checkbox" />RBAC: Azure AI User auf
        Foundry Project</label></li>
        <li><label><input
        type="checkbox" /><code>requirements.txt</code> mit
        MAF-Packages</label></li>
        <li><label><input type="checkbox" />Basis-Endpoint
        testen</label></li>
        </ul>
        <h3 id="phase-2-auratriage-erstellen-0.5-tage">Phase 2:
        AURATriage erstellen (0.5 Tage)</h3>
        <ul class="task-list">
        <li><label><input type="checkbox" />Agent in Foundry Portal
        erstellen</label></li>
        <li><label><input type="checkbox" />System Instructions
        definieren</label></li>
        <li><label><input type="checkbox" />JSON-Output
        testen</label></li>
        </ul>
        <h3 id="phase-3-maf-workflow-implementieren-1-2-tage">Phase 3:
        MAF Workflow implementieren (1-2 Tage)</h3>
        <ul class="task-list">
        <li><label><input type="checkbox" /><code>mfa_workflow.py</code>
        implementieren</label></li>
        <li><label><input type="checkbox" />Triage â†’ Fan-Out â†’ Fan-In â†’
        Synthesizer</label></li>
        <li><label><input type="checkbox" />Lokal testen mit Azure
        Functions Core Tools</label></li>
        <li><label><input type="checkbox" />Deploy und
        E2E-Test</label></li>
        </ul>
        <h3 id="phase-4-proxy-integration-0.5-tage">Phase 4:
        Proxy-Integration (0.5 Tage)</h3>
        <ul class="task-list">
        <li><label><input
        type="checkbox" /><code>handleMFARequest()</code>
        implementieren</label></li>
        <li><label><input
        type="checkbox" /><code>loadMFAConfigs()</code>
        implementieren</label></li>
        <li><label><input type="checkbox" />.env.local
        erweitern</label></li>
        <li><label><input type="checkbox" />Testen</label></li>
        </ul>
        <h3 id="phase-5-frontend-erweiterung-0.5-tage">Phase 5:
        Frontend-Erweiterung (0.5 Tage)</h3>
        <ul class="task-list">
        <li><label><input type="checkbox" />Switch-Dropdown
        erweitern</label></li>
        <li><label><input type="checkbox" />MFA-Option
        hinzufÃ¼gen</label></li>
        <li><label><input type="checkbox" />E2E-Test</label></li>
        </ul>
        <p><strong>GeschÃ¤tzter Gesamtaufwand: 3-4 Werktage
        (PoC/Start)</strong></p>
        <hr />
        <h2 id="risikobewertung">10. Risikobewertung</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Das grÃ¶ÃŸte Risiko ist,
        dass MAF Preview-Software ist und Breaking Changes enthalten
        kann. Mitigation: Version-Pinning in
        <code>requirements.txt</code>. Das zweitgrÃ¶ÃŸte Risiko sind Cold
        Starts bei Consumption Plan (erste Anfrage nach InaktivitÃ¤t
        dauert lÃ¤nger). Mitigation: Flex Consumption Plan oder
        Keep-Alive-Ping.</p>
        </blockquote>
        <table style="width:100%;">
        <colgroup>
        <col style="width: 21%" />
        <col style="width: 26%" />
        <col style="width: 21%" />
        <col style="width: 31%" />
        </colgroup>
        <thead>
        <tr>
        <th>Risiko</th>
        <th>Wahrsch.</th>
        <th>Impact</th>
        <th>Mitigation</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td>MAF ist Preview (Breaking Changes)</td>
        <td>Mittel</td>
        <td>Hoch</td>
        <td>Version pinnen, vor Update testen</td>
        </tr>
        <tr>
        <td>Azure Function Cold Start</td>
        <td>Sicher</td>
        <td>Niedrig</td>
        <td>Consumption: Keep-Alive/Ping; Premium: prewarmed
        workers</td>
        </tr>
        <tr>
        <td>Triage gibt kein valides JSON</td>
        <td>Mittel</td>
        <td>Mittel</td>
        <td>Fallback: Alle Agenten aufrufen</td>
        </tr>
        <tr>
        <td>Foundry API Ã¤ndert sich</td>
        <td>Niedrig</td>
        <td>Hoch</td>
        <td>MAF-SDK abstrahiert das</td>
        </tr>
        <tr>
        <td>HTTP Trigger Response-Limit (230s, dokumentiert)</td>
        <td>Niedrig</td>
        <td>Hoch</td>
        <td>Timeout 210s + Async Pattern (Durable) falls nÃ¶tig
        îˆ€citeîˆ‚turn2view3îˆ</td>
        </tr>
        <tr>
        <td>Bestehende Prozesse brechen</td>
        <td>Sehr niedrig</td>
        <td>Kritisch</td>
        <td>Komplett isoliert, eigene ID-Range</td>
        </tr>
        </tbody>
        </table>
        <hr />
        <h2 id="entscheidungen-review-abgeschlossen">11. Entscheidungen
        (Review abgeschlossen)</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Die wichtigsten
        Architekturentscheidungen: (1) Flex Consumption Plan fÃ¼r die
        Azure Function (empfohlen ab Dezember 2025), (2) Function Key
        fÃ¼r Authentifizierung zwischen Proxy und Function, (3) Timeout
        von 210 Sekunden (<code>host.json</code>), (4) Retry-Policy mit
        3 Versuchen und exponentiellem Backoff.</p>
        </blockquote>
        <ol type="1">
        <li><p><strong>Hosting-Plan:</strong> Start mit
        <strong>Consumption</strong> (PoC/Cost).<br />
        <strong>Wechsel auf Premium/Flex Consumption</strong>, wenn
        mindestens eines zutrifft:</p>
        <ul>
        <li>Latenz muss <strong>konstant niedrig</strong> sein und Cold
        Starts sind nicht akzeptabel.</li>
        <li>Hohe gleichzeitige Nutzung (viele parallele Requests) fÃ¼hrt
        zu spÃ¼rbaren Queues.</li>
        <li>Laufzeiten nÃ¤hern sich regelmÃ¤ÃŸig dem HTTP-Response-Limit
        (siehe 4.6) oder es wird ein Async-Pattern nÃ¶tig.</li>
        </ul></li>
        <li><p><strong>Auth (Proxy â†’ Function):</strong> Start mit
        <strong>Function Key</strong>
        (<code>x-functions-key</code>).<br />
        Premium/Enterprise-HÃ¤rtung spÃ¤ter: Azure AD/EasyAuth + Managed
        Identity (Keyless).</p></li>
        <li><p><strong>Timeout:</strong></p>
        <ul>
        <li><code>host.json</code> <code>functionTimeout</code>:
        <strong>00:03:30</strong> (210s)<br />
        </li>
        <li>Proxy Fetch Timeout (Node): <strong>200s</strong><br />
        </li>
        <li>Retry-Policy Proxy â†’ Function: <strong>3 Versuche</strong>,
        Backoff <strong>1s / 2s / 4s</strong>, nur bei
        5xx/Network-Errors.</li>
        </ul></li>
        <li><p><strong>Logging/Traces:</strong></p>
        <ul>
        <li>Azure Function: <strong>Application Insights</strong>
        aktivieren.<br />
        </li>
        <li>Proxy: bestehende Logs beibehalten; zusÃ¤tzlich
        <code>x-correlation-id</code> Header durchreichen.</li>
        </ul></li>
        <li><p><strong>Fallback:</strong> Wenn MFA Function nicht
        erreichbar oder 5xx nach Retries â†’ optionaler Fallback auf
        bestehenden <strong>Foundry Workflow</strong> (sequenziell), um
        Service-Continuity zu halten.</p></li>
        </ol>
        <hr />
        <h2 id="referenzen">12. Referenzen</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Alle wichtigen Links
        zur offiziellen Microsoft-Dokumentation fÃ¼r MAF, Azure Functions
        und Azure AI Foundry. Das Microsoft Agent Framework Repository
        auf GitHub enthÃ¤lt Python-Beispiele fÃ¼r parallele Workflows
        unter
        <code>/samples/getting_started/workflows/parallelism</code>.</p>
        </blockquote>
        <ul>
        <li><a
        href="https://github.com/microsoft/agent-framework">Microsoft
        Agent Framework GitHub</a></li>
        <li><a
        href="https://github.com/microsoft/agent-framework/tree/main/python/samples/getting_started/workflows/parallelism">MAF
        Parallelism Samples</a></li>
        <li><a
        href="https://learn.microsoft.com/en-us/azure/ai-foundry/agents/">Azure
        AI Foundry Agent Service</a></li>
        <li><a
        href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-reference-python">Azure
        Functions Python Developer Guide</a></li>
        </ul>
        <hr />
        <p><em>Dokument erstellt fÃ¼r Review. Feedback
        willkommen.</em></p>
        <h2 id="maf-recherche-validiert-mit-quellen">13. MAF Recherche
        (validiert, mit Quellen)</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Eine FAQ-Tabelle mit
        validierten Antworten zu MAF-Fragen. Wichtigste Erkenntnis: Die
        Klasse heiÃŸt <code>AzureAIClient</code> (nicht
        <code>AzureAIAgentClient</code>), der Import ist
        <code>from agent_framework.azure import AzureAIClient</code>,
        und Agents werden per <code>agent_name=</code> +
        <code>use_latest_version=True</code> aufgelÃ¶st (nicht per
        <code>agent_id</code>).</p>
        </blockquote>
        <blockquote>
        <p>âš ï¸ <strong>WICHTIGE KORREKTUR:</strong> Die ursprÃ¼ngliche
        Recherche verwendete teilweise veraltete Begriffe
        (<code>AzureAIAgentClient</code>, <code>agent_id</code>). Die
        <strong>korrekte</strong> Klasse ist <code>AzureAIClient</code>
        aus <code>agent_framework.azure</code>, und Agents werden per
        <strong>Name</strong> (<code>agent_name=</code>) aufgelÃ¶st,
        nicht per ID.</p>
        </blockquote>
        <p>Tabelle: <strong>Frage â†’ Antwort â†’ Quelle</strong></p>
        <table>
        <colgroup>
        <col style="width: 33%" />
        <col style="width: 33%" />
        <col style="width: 33%" />
        </colgroup>
        <thead>
        <tr>
        <th>Frage</th>
        <th>Antwort</th>
        <th>Quelle</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td>Was ist <del><code>AzureAIAgentClient</code></del>
        <code>AzureAIClient</code>?</td>
        <td>Python SDK-Client fÃ¼r Azure AI Foundry Agents; erstellt
        einen <code>ChatAgent</code> Ã¼ber <code>create_agent()</code>.
        <strong>Import:</strong>
        <code>from agent_framework.azure import AzureAIClient</code></td>
        <td>https://learn.microsoft.com/en-us/python/api/agent-framework-core/agent_framework.azure.azureaiagentclient?view=agent-framework-python-latest</td>
        </tr>
        <tr>
        <td>Wie werden Foundry Agents in MAF Workflows genutzt?</td>
        <td>Ãœber
        <code>AzureAIClient(agent_name=..., use_latest_version=True).create_agent()</code>
        wird ein <code>ChatAgent</code> erzeugt, der per
        <code>run()</code> aufgerufen wird. <strong>âš ï¸ NICHT
        <code>agent_id</code> verwenden!</strong></td>
        <td>https://learn.microsoft.com/en-us/python/api/agent-framework-core/agent_framework.azure.azureaiagentclient?view=agent-framework-python-latest</td>
        </tr>
        <tr>
        <td>UnterstÃ¼tzt MAF Fan-In / Fan-Out?</td>
        <td><code>WorkflowBuilder</code> bietet
        <code>add_fan_in_edges()</code> und
        <code>add_fan_out_edges()</code>. <strong>Hinweis:</strong> FÃ¼r
        einfache Flows ist WorkflowBuilder Overkill - einfache
        if/else-Logik genÃ¼gt.</td>
        <td>https://learn.microsoft.com/en-us/python/api/agent-framework-core/agent_framework.workflowbuilder?view=agent-framework-python-latest</td>
        </tr>
        <tr>
        <td>UnterstÃ¼tzt MAF dynamische Multi-Selection (Triage
        entscheidet)?</td>
        <td><code>add_multi_selection_edge_group()</code> ist verfÃ¼gbar,
        aber fÃ¼r unseren Use-Case wurde einfachere if/else-Logik
        implementiert.</td>
        <td>https://learn.microsoft.com/en-us/python/api/agent-framework-core/agent_framework.workflowbuilder?view=agent-framework-python-latest</td>
        </tr>
        <tr>
        <td>Gibt es Fallstricke mit Executor-Instanzen?</td>
        <td>Wenn Executor-Instanzen direkt Ã¼bergeben werden, kÃ¶nnen sie
        Ã¼ber mehrere Workflow-Instanzen geteilt werden;
        <code>register_executor/register_agent</code> ist der sichere
        Weg, falls Workflows gecached werden.</td>
        <td>https://learn.microsoft.com/en-us/python/api/agent-framework-core/agent_framework.workflowbuilder?view=agent-framework-python-latest</td>
        </tr>
        <tr>
        <td>Wie wird Azure Functions Timeout konfiguriert?</td>
        <td><code>functionTimeout</code> in <code>host.json</code>
        (timespan string). Fixed upper bound empfohlen.</td>
        <td>https://learn.microsoft.com/en-us/azure/azure-functions/functions-host-json</td>
        </tr>
        <tr>
        <td>Welche Defaults/Maxima gelten je Plan und was ist das
        HTTP-Limit?</td>
        <td>Consumption: default 5 min, max 10 min; <strong>HTTP Trigger
        max ~230s Response</strong> (Load Balancer Idle Timeout).</td>
        <td>https://learn.microsoft.com/en-us/azure/azure-functions/functions-scale</td>
        </tr>
        </tbody>
        </table>
        <p><strong>Technische Schlussfolgerung (Go/No-Go):</strong>
        <strong>GO</strong> fÃ¼r additive EinfÃ¼hrung von MFA/MAF, sofern
        Version-Pinning + Timeout 210s + isoliertes Routing strikt
        eingehalten werden.</p>
        <hr />
        <h2 id="externer-entwickler-guide-verbindlich">14. Externer
        Entwickler Guide (verbindlich)</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Eine strenge
        Schritt-fÃ¼r-Schritt-Anleitung fÃ¼r externe Entwickler. Die
        wichtigsten Regeln: (1) Arbeite in einem eigenen Branch, nie
        direkt auf <code>main</code>, (2) Ã„ndere niemals
        <code>handleAgentRequest()</code> oder
        <code>handleWorkflowRequest()</code> logisch, (3) Nutze
        <code>type: "mfa"</code> als neues Routing-Kriterium, (4) Teste
        lokal bevor du deployst.</p>
        </blockquote>
        <h3 id="kurze-projektbeschreibung">14.1 Kurze
        Projektbeschreibung</h3>
        <p>CONTEXTPILOT besitzt heute zwei stabile AusfÃ¼hrungswege: -
        <strong>Agent</strong> (Foundry Agent direkt) -
        <strong>Workflow</strong> (Foundry Workflow sequenziell)</p>
        <p>Neu wird ein <strong>dritter</strong> Weg hinzugefÃ¼gt: -
        <strong>MFA / MAF</strong> (Azure Function + Microsoft Agent
        Framework, aktuell sequenziell, Endziel: parallelisiert)</p>
        <p>Dieser dritte Weg ist <strong>rein additiv</strong>. Nichts
        Bestehendes wird ersetzt oder verÃ¤ndert.</p>
        <h3 id="ziel">14.2 Ziel</h3>
        <p>Du musst einen neuen, unabhÃ¤ngigen AusfÃ¼hrungsweg
        implementieren, der: 1. <strong>Bestehende Agent- und
        Workflow-Prozesse nicht zerstÃ¶rt</strong> (Regression-frei). 2.
        Lokal als PoC funktioniert. 3. Danach unverÃ¤ndert (nur Konfig)
        auf Azure Functions deployt werden kann. 4. MAF nutzt, um
        <code>AURATriage</code> â†’ (Web/Context sequenziell, Endziel:
        parallel) â†’ Synthesizer auszufÃ¼hren.</p>
        <h3 id="plan-34-werktage">14.3 Plan (3â€“4 Werktage)</h3>
        <p><strong>Tag 1 (0.5â€“1.0d):</strong> Repo/Branch Setup + lokale
        Function Skeleton + Requirements pinned + Healthcheck.<br />
        <strong>Tag 1â€“2 (1.0â€“1.5d):</strong> MAF Workflow implementieren
        (Triage + Multi-Selection + Fan-In + Synthese) + lokale
        Tests.<br />
        <strong>Tag 3 (0.5â€“1.0d):</strong> Proxy: minimaler
        MFA-Routing-Pfad + Retry/Timeout + UI dropdown (optional) + E2E
        lokal.<br />
        <strong>Tag 4 (0.5d, optional):</strong> Azure Deploy
        (Consumption) + RBAC/MI + App Insights + E2E in Azure.</p>
        <h3 id="settings-konkrete-werte-direkt-Ã¼bernehmbar">14.4
        Settings (konkrete Werte â€“ direkt Ã¼bernehmbar)</h3>
        <p><strong>Azure Function (Start: Consumption, HTTP
        Trigger):</strong> - <code>host.json</code>: -
        <code>functionTimeout</code>: <strong>00:03:30</strong>
        (210s)<br />
        (BegrÃ¼ndung: Microsoft dokumentiert ein 230s Timeout fÃ¼r HTTP
        Trigger Responses durch den Azure Load Balancer; daher bewusst
        darunter bleiben.) îˆ€citeîˆ‚turn2view3îˆ - App Settings (Function):
        - <code>AZURE_AI_PROJECT_ENDPOINT</code>:
        <code>https://&lt;your-project&gt;.services.ai.azure.com/api/projects/&lt;project-id&gt;</code>
        îˆ€citeîˆ‚turn6view0îˆ - <code>AZURE_AI_MODEL_DEPLOYMENT_NAME</code>:
        <code>gpt-4o-mini</code> (oder euer Deployment-Name)
        îˆ€citeîˆ‚turn6view0îˆ - <del><code>AURA_TRIAGE_AGENT_ID</code></del>
        âŒ <strong>FALSCH - Verwende Namen statt IDs:</strong> -
        <code>AURA_TRIAGE_AGENT_NAME</code>: <code>AURATriage</code> âœ…
        - <code>AURA_WEB_AGENT_NAME</code>:
        <code>AURAContextPilotWeb</code> âœ… -
        <code>AURA_CONTEXT_AGENT_NAME</code>:
        <code>AURAContextPilot</code> âœ… -
        <code>AURA_SYNTHESIZER_AGENT_NAME</code>:
        <code>AURAContextPilotResponseSynthesizer</code> âœ… -
        <code>AURA_QUICK_AGENT_NAME</code>:
        <code>AURAContextPilotQuick</code> âœ… (fÃ¼r Direct Response) -
        Logging: Application Insights <strong>on</strong></p>
        <p><strong>Proxy â†’ Function (Node):</strong> - Request Timeout:
        <strong>200s</strong> - Retries: <strong>3</strong> (nur bei
        Network errors / 5xx) - Backoff: <strong>1s, 2s, 4s</strong> -
        Auth: Header <code>x-functions-key</code> (Function Key)
        îˆ€citeîˆ‚turn2view3îˆ</p>
        <p><strong>MAF Package Pins (direkt Ã¼bernehmbar):</strong> -
        <code>agent-framework-core==1.0.0b251223</code> -
        <code>agent-framework-azure-ai==1.0.0b251223</code> -
        <code>azure-ai-projects==2.0.0b2</code> -
        <code>azure-ai-agents==1.2.0b5</code> -
        <code>aiohttp==3.13.2</code> îˆ€citeîˆ‚turn9search7îˆ ### 14.5
        Schritt-fÃ¼r-Schritt Anleitung (streng)</p>
        <ol type="1">
        <li><p><strong>Branch-Regel (verpflichtend):</strong><br />
        Du musst in einem neuen Branch arbeiten. Es ist verboten direkt
        auf <code>main</code> zu arbeiten.</p></li>
        <li><p><strong>No-Touch-Regel (verpflichtend):</strong><br />
        Es ist verboten, bestehende Funktionen
        <code>handleAgentRequest()</code> und
        <code>handleWorkflowRequest()</code> logisch zu verÃ¤ndern.<br />
        Erlaubt ist ausschlieÃŸlich:</p>
        <ul>
        <li>ein zusÃ¤tzlicher
        <code>if (agent.type === "mfa") return handleMFARequest(...);</code></li>
        <li>neue, isolierte Funktionen/Dateien
        (<code>handleMFARequest</code>, <code>loadMFAConfigs</code>,
        etc.) Wenn du mehr Ã¤ndern willst, musst du vorher fragen.</li>
        </ul></li>
        <li><p><strong>Neuer Weg = neuer Typ:</strong><br />
        Du musst <code>type: "mfa"</code> als separates
        Routing-Kriterium nutzen.<br />
        Du darfst niemals bestehende <code>type: "agent"</code> oder
        <code>type: "workflow"</code> Semantik Ã¤ndern.</p></li>
        <li><p><strong>Lokaler PoC zuerst:</strong><br />
        Bevor du irgendetwas nach Azure deployt, musst du lokal
        folgendes nachweisen:</p>
        <ul>
        <li>Function startet lokal.</li>
        <li><code>POST /api/mfa</code> liefert JSON
        <code>{ "output_text": "...", "workflow": "mfa" }</code>.</li>
        <li>Triage JSON Parsing funktioniert (inkl. Fallback: beide
        Agents).</li>
        <li>Web/Context werden korrekt aufgerufen (aktuell sequenziell,
        Endziel: parallel).</li>
        </ul></li>
        <li><p><del><strong>MAF Workflow
        (Pflichtstruktur):</strong></del> âŒ <strong>KORREKTUR:
        WorkflowBuilder ist NICHT nÃ¶tig!</strong></p>
        <blockquote>
        <p>âš ï¸ Der ursprÃ¼ngliche Plan sah <code>WorkflowBuilder</code>
        vor. In der Praxis reicht einfache
        <strong>if/else-Logik</strong>. Siehe
        <code>contextpilot-mfa-function/mfa_workflow.py</code></p>
        </blockquote>
        <p><del>Du musst exakt diese Struktur implementieren:</del></p>
        <ul>
        <li>Start: <code>AURATriage</code></li>
        <li><del>Routing: <code>add_multi_selection_edge_group()</code>
        (Triage entscheidet)</del></li>
        <li><del>Fan-In: <code>add_fan_in_edges()</code> â†’
        <code>AURAContextPilotResponseSynthesizer</code></del> <del>Der
        Workflow darf nicht sequenziell sein.</del></li>
        </ul></li>
        <li><p><del><strong>AzureAIAgentClient VerstÃ¤ndnis
        (Pflicht):</strong></del> âŒ KORREKTUR: Die Klasse heiÃŸt
        <code>AzureAIClient</code>! Du darfst
        <code>AzureAIAgentClient</code> nicht als â€œAgentâ€
        bezeichnen.<br />
        Es ist der Python-Client, der einen Foundry Agent als
        <code>ChatAgent</code> instanziert.</p></li>
        <li><p><strong>Timeout-Regel (HTTP):</strong><br />
        Du musst sicherstellen, dass der Workflow typischerweise &lt;60s
        bleibt.<br />
        Es ist verboten, bewusst Workloads zu bauen, die nahe 230s
        laufen, ohne Async Pattern.</p></li>
        <li><p><strong>Deployment erst nach Checkliste:</strong><br />
        Du darfst erst deployen, wenn:</p>
        <ul>
        <li>requirements pinned sind</li>
        <li>functionTimeout 210s gesetzt ist</li>
        <li>MI/RBAC gesetzt ist</li>
        <li>Proxy MFA Route nur additiv implementiert ist</li>
        <li>E2E Test lokal erfolgreich ist</li>
        </ul></li>
        <li><p><strong>Regression-Tests (Pflicht):</strong><br />
        Vor Merge musst du demonstrieren:</p>
        <ul>
        <li>Agent-Modus funktioniert weiterhin.</li>
        <li>Workflow-Modus funktioniert weiterhin.</li>
        <li>MFA-Modus funktioniert. Wenn einer der drei Modi nicht
        funktioniert: Du darfst nicht mergen.</li>
        </ul></li>
        </ol>
        <hr />
        <h2 id="referenzen-zusÃ¤tzlich-zu-kap.-12">15. Referenzen
        (zusÃ¤tzlich zu Kap. 12)</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Direkte Links zu den
        Microsoft Learn API-Dokumentationen fÃ¼r
        <code>WorkflowBuilder</code> (DAG-Workflows),
        <code>AzureAIClient</code> (Agent-Instanzierung), sowie Azure
        Functions Hosting-Optionen und Timeout-Konfiguration in
        <code>host.json</code>.</p>
        </blockquote>
        <ul>
        <li>MAF WorkflowBuilder API:
        https://learn.microsoft.com/en-us/python/api/agent-framework-core/agent_framework.workflowbuilder?view=agent-framework-python-latest</li>
        <li>MAF AzureAIAgentClient API:
        https://learn.microsoft.com/en-us/python/api/agent-framework-core/agent_framework.azure.azureaiagentclient?view=agent-framework-python-latest</li>
        <li>Azure Functions Hosting/Timeouts:
        https://learn.microsoft.com/en-us/azure/azure-functions/functions-scale</li>
        <li>Azure Functions host.json:
        https://learn.microsoft.com/en-us/azure/azure-functions/functions-host-json</li>
        </ul>
        <hr />
        <h2 id="deployment-guide">16. Deployment Guide</h2>
        <blockquote>
        <p><strong>Was Sie hier lernen:</strong> Eine vollstÃ¤ndige,
        validierte Anleitung fÃ¼r das Azure-Deployment. Dieses Kapitel
        dokumentiert die tatsÃ¤chlich durchgefÃ¼hrten Schritte inkl.
        Fehlerbehebung. Kritische Erkenntnisse: (1)
        <code>agent-framework-azure-ai</code> MUSS in requirements.txt
        stehen, (2) Lazy Imports in <code>function_app.py</code>
        verhindern â€œ0 Functionsâ€-Fehler, (3) â€œAzure AI Userâ€-Rolle muss
        auf der Resource Group des AI Foundry Projects gesetzt
        werden.</p>
        </blockquote>
        <p><strong>Version:</strong> 1.0<br />
        <strong>Datum:</strong> 26. Dezember 2025<br />
        <strong>Status:</strong> Produktiv validiert</p>
        <hr />
        <h3 id="executive-summary">16.1 Executive Summary</h3>
        <p>Dieses Kapitel dokumentiert das vollstÃ¤ndige Deployment der
        CONTEXTPILOT MFA-LÃ¶sung auf Azure. Die LÃ¶sung besteht aus drei
        Hauptkomponenten:</p>
        <ol type="1">
        <li><strong>Azure Function App</strong>
        (<code>contextpilot-mfa-func</code>) - FÃ¼hrt den
        Multi-Agent-Workflow mit Microsoft Agent Framework (MAF)
        aus</li>
        <li><strong>Proxy Server</strong>
        (<code>contextpilot-proxy-2025</code>) - Routet Anfragen und
        bietet die API fÃ¼r das Frontend</li>
        <li><strong>Static Web App</strong>
        (<code>ashy-dune-06d0e9810</code>) - Das React-Frontend</li>
        </ol>
        <p><strong>Was wir erreicht haben:</strong> - âœ… Python-basierte
        Azure Function mit 5 Agents (Triage, Quick, Web, Context,
        Synthesizer) - âœ… Flex Consumption Hosting Plan (empfohlen ab
        Dezember 2025) - âœ… Managed Identity mit korrekten
        RBAC-Berechtigungen - âœ… CI/CD via GitHub Actions fÃ¼r
        automatische Deployments - âœ… Lazy Imports zur Vermeidung von
        Indexing-Fehlern</p>
        <hr />
        <h3 id="ressourcen-architektur">16.2 Ressourcen-Architektur</h3>
        <h4 id="executive-summary-1">16.2.1 Executive Summary</h4>
        <p>Die CONTEXTPILOT-LÃ¶sung verwendet Ressourcen in <strong>zwei
        Azure Resource Groups</strong>. Diese Trennung ist wichtig fÃ¼r
        die RBAC-Konfiguration, da Berechtigungen auf der richtigen
        Resource Group gesetzt werden mÃ¼ssen.</p>
        <h4 id="technische-details">16.2.2 Technische Details</h4>
        <p><strong>Resource Group:
        <code>ContextPilot-Resource</code></strong> (Switzerland
        North)</p>
        <table>
        <colgroup>
        <col style="width: 47%" />
        <col style="width: 21%" />
        <col style="width: 30%" />
        </colgroup>
        <thead>
        <tr>
        <th>Ressource</th>
        <th>Typ</th>
        <th>Zweck</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><code>contextpilot-mfa-func</code></td>
        <td>Function App (Flex Consumption)</td>
        <td>MFA-Workflow AusfÃ¼hrung</td>
        </tr>
        <tr>
        <td><code>contextpilot-proxy-2025</code></td>
        <td>App Service (Linux Node.js)</td>
        <td>Proxy Server fÃ¼r Frontend</td>
        </tr>
        <tr>
        <td><code>contextpilotmfastore</code></td>
        <td>Storage Account</td>
        <td>Function App Storage</td>
        </tr>
        <tr>
        <td><code>contextpilot-proxy-2025</code></td>
        <td>Application Insights</td>
        <td>Monitoring Proxy</td>
        </tr>
        <tr>
        <td><code>contextpilot-mfa-func</code></td>
        <td>Application Insights</td>
        <td>Monitoring Function</td>
        </tr>
        </tbody>
        </table>
        <p><strong>Resource Group:
        <code>Area-Review-Resource</code></strong> (Sweden Central)</p>
        <table>
        <colgroup>
        <col style="width: 47%" />
        <col style="width: 21%" />
        <col style="width: 30%" />
        </colgroup>
        <thead>
        <tr>
        <th>Ressource</th>
        <th>Typ</th>
        <th>Zweck</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><code>contextpilot-resource</code></td>
        <td>Azure AI Services</td>
        <td>AI Foundry Account</td>
        </tr>
        <tr>
        <td><code>contextpilot-resource/contextpilot</code></td>
        <td>AI Foundry Project</td>
        <td>EnthÃ¤lt alle Agents</td>
        </tr>
        </tbody>
        </table>
        <p><strong>Architektur-Diagramm:</strong></p>
        <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Resource Group: ContextPilot-Resource (Switzerland North)                  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Static Web App      â”‚â”€â”€â”€â”€â–¶â”‚ Proxy Server                â”‚                â”‚
â”‚  â”‚ (Frontend React)    â”‚     â”‚ contextpilot-proxy-2025     â”‚                â”‚
â”‚  â”‚ ashy-dune-06d0e9810 â”‚     â”‚ Node.js 22.x                â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                             â”‚                               â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                              â”‚                             â”‚                â”‚
â”‚                              â–¼                             â–¼                â”‚
â”‚                    type: &quot;agent/workflow&quot;           type: &quot;mfa&quot;             â”‚
â”‚                              â”‚                             â”‚                â”‚
â”‚                              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                              â”‚              â–¼                               â”‚
â”‚                              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                              â”‚    â”‚ Function App                â”‚           â”‚
â”‚                              â”‚    â”‚ contextpilot-mfa-func       â”‚           â”‚
â”‚                              â”‚    â”‚ Python 3.11 + MAF           â”‚           â”‚
â”‚                              â”‚    â”‚ Flex Consumption Plan       â”‚           â”‚
â”‚                              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                              â”‚                   â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚                   â”‚
                               â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Resource Group: Area-Review-Resource (Sweden Central)                      â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Azure AI Foundry: contextpilot-resource                             â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  Project: contextpilot                                              â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ AURATriage                                                     â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ AURAContextPilotQuick                                          â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ AURAContextPilotWeb                                            â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ AURAContextPilot (Index)                                       â”‚    â”‚
â”‚  â”‚  â””â”€â”€ AURAContextPilotResponseSynthesizer                            â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  Endpoint: https://contextpilot-resource.services.ai.azure.com      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        <hr />
        <h3 id="azure-function-app-deployment">16.3 Azure Function App
        Deployment</h3>
        <h4 id="executive-summary-2">16.3.1 Executive Summary</h4>
        <p>Wir haben eine <strong>Python-basierte Azure
        Function</strong> erstellt, die den Multi-Agent-Workflow
        orchestriert. Die Function verwendet das <strong>Flex
        Consumption</strong> Hosting-Modell (empfohlen ab Dezember
        2025), das Linux Consumption ablÃ¶st. Der Code wird via
        <code>func azure functionapp publish</code> deployed.</p>
        <p><strong>Wichtigste Erkenntnis:</strong> Das Package
        <code>agent-framework-azure-ai</code> muss in
        <code>requirements.txt</code> stehen, da es den
        <code>AzureAIClient</code> enthÃ¤lt.
        <code>agent-framework-core</code> allein reicht nicht!</p>
        <h4 id="technische-details-1">16.3.2 Technische Details</h4>
        <p><strong>1. Function App erstellen (Flex
        Consumption)</strong></p>
        <div class="sourceCode" id="cb34"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flex Consumption ist der neue Standard (Dezember 2025)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Linux Consumption wird ab September 2028 nicht mehr unterstÃ¼tzt</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>az functionapp create `</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>resource-group ContextPilot-Resource `</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>name contextpilot-mfa-func `</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>storage-account contextpilotmfastore `</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>flexconsumption-location centralus `</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>runtime python `</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>runtime-version <span class="dv">3.11</span> `</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>functions-version <span class="dv">4</span></span></code></pre></div>
        <p><strong>Hinweis:</strong> Flex Consumption ist nicht in allen
        Regionen verfÃ¼gbar. Central US, East US, West Europe sind
        unterstÃ¼tzt.</p>
        <p><strong>2. Dateistruktur der Function</strong></p>
        <pre><code>contextpilot-mfa-function/
â”œâ”€â”€ function_app.py          # HTTP Trigger (Python v2 Model)
â”œâ”€â”€ mfa_workflow.py           # MAF Workflow-Logik
â”œâ”€â”€ requirements.txt          # Python Dependencies
â”œâ”€â”€ host.json                 # Function Host Konfiguration
â”œâ”€â”€ local.settings.json       # Lokale Umgebungsvariablen (nicht committen!)
â”œâ”€â”€ local.settings.json.template  # Template fÃ¼r lokale Entwicklung
â””â”€â”€ .gitignore</code></pre>
        <p><strong>3. requirements.txt (kritisch!)</strong></p>
        <pre class="pip-requirements"><code># Azure Functions Runtime
azure-functions==1.13.3

# Microsoft Agent Framework (MAF) â€“ BEIDE Packages sind nÃ¶tig!
# agent-framework-core ist das Base-Package
# agent-framework-azure-ai enthÃ¤lt AzureAIClient (fÃ¼r Azure AI Foundry Integration)
agent-framework-core==1.0.0b251223
agent-framework-azure-ai==1.0.0b251223

# azure-ai-projects V2 fÃ¼r existing agents by name
azure-ai-projects==2.0.0b2

# HTTP stack
aiohttp==3.13.2

# Auth / Typing
azure-identity&gt;=1.17.0
pydantic&gt;=2.6.0,&lt;3</code></pre>
        <p><strong>âš ï¸ WICHTIG:</strong> Ohne
        <code>agent-framework-azure-ai</code> erscheint folgender
        Fehler:</p>
        <pre><code>ModuleNotFoundError: The package agent-framework-azure-ai is required to use `AzureAIClient`.</code></pre>
        <p><strong>4. function_app.py mit Lazy Import
        (kritisch!)</strong></p>
        <div class="sourceCode" id="cb38"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;Azure Function HTTP Trigger fÃ¼r CONTEXTPILOT MFA.&quot;&quot;&quot;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> azure.functions <span class="im">as</span> func</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># WICHTIG: KEIN Top-Level Import von mfa_workflow!</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Das wÃ¼rde das Function-Indexing blockieren, wenn Dependencies fehlen.</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> func.FunctionApp(http_auth_level<span class="op">=</span>func.AuthLevel.ANONYMOUS)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(route<span class="op">=</span><span class="st">&quot;healthz&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>])</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> healthz(req: func.HttpRequest) <span class="op">-&gt;</span> func.HttpResponse:</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Health check endpoint - lÃ¤dt ohne Heavy-Imports.&quot;&quot;&quot;</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        json.dumps({<span class="st">&quot;ok&quot;</span>: <span class="va">True</span>, <span class="st">&quot;version&quot;</span>: <span class="st">&quot;2.4&quot;</span>}),</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>        status_code<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>        mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(route<span class="op">=</span><span class="st">&quot;mfa&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> mfa_endpoint(req: func.HttpRequest) <span class="op">-&gt;</span> func.HttpResponse:</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;MFA Endpoint - Lazy Import von mfa_workflow.&quot;&quot;&quot;</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    correlation_id <span class="op">=</span> req.headers.get(<span class="st">&quot;x-correlation-id&quot;</span>) <span class="kw">or</span> <span class="bu">str</span>(uuid.uuid4())</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>        body <span class="op">=</span> req.get_json()</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>            json.dumps({<span class="st">&quot;error&quot;</span>: <span class="st">&quot;Invalid JSON&quot;</span>}),</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">400</span>,</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>            mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> (body <span class="kw">or</span> {}).get(<span class="st">&quot;prompt&quot;</span>)</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(prompt, <span class="bu">str</span>) <span class="kw">or</span> <span class="kw">not</span> prompt.strip():</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>            json.dumps({<span class="st">&quot;error&quot;</span>: <span class="st">&quot;Missing &#39;prompt&#39; in request body&quot;</span>}),</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">400</span>,</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>            mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># LAZY IMPORT: Verhindert, dass Worker-Indexing bei ImportError ausfÃ¤llt</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> mfa_workflow <span class="im">import</span> run_mfa_workflow</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> run_mfa_workflow(prompt)</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>            json.dumps({</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;output_text&quot;</span>: result[<span class="st">&quot;response&quot;</span>],</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;workflow&quot;</span>: <span class="st">&quot;mfa&quot;</span>,</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;agents_used&quot;</span>: result[<span class="st">&quot;agents_used&quot;</span>],</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;routing&quot;</span>: result[<span class="st">&quot;routing&quot;</span>],</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>            }),</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>            mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>            headers<span class="op">=</span>{<span class="st">&quot;x-correlation-id&quot;</span>: correlation_id},</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>        logging.exception(<span class="st">&quot;MFA failed (cid=</span><span class="sc">%s</span><span class="st">)&quot;</span>, correlation_id)</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func.HttpResponse(</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>            json.dumps({<span class="st">&quot;error&quot;</span>: <span class="bu">str</span>(e), <span class="st">&quot;hint&quot;</span>: <span class="st">&quot;Check Azure Function logs&quot;</span>}),</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>            mimetype<span class="op">=</span><span class="st">&quot;application/json&quot;</span>,</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
        <p><strong>âš ï¸ KRITISCH - Lazy Import Pattern:</strong></p>
        <p>Bei Azure Functions Python v2 Model werden alle HTTP Triggers
        durch Import von <code>function_app.py</code> indexiert. Wenn
        dabei eine Exception auftritt (z.B.
        <code>ModuleNotFoundError</code>), werden <strong>0
        Functions</strong> registriert, obwohl das Deployment
        â€œerfolgreichâ€ war.</p>
        <p><strong>Falsch (blockiert Indexing):</strong></p>
        <div class="sourceCode" id="cb39"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mfa_workflow <span class="im">import</span> run_mfa_workflow  <span class="co"># TOP-LEVEL = GEFÃ„HRLICH!</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(route<span class="op">=</span><span class="st">&quot;mfa&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> mfa_endpoint(req):</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="cf">await</span> run_mfa_workflow(...)</span></code></pre></div>
        <p><strong>Richtig (Lazy Import):</strong></p>
        <div class="sourceCode" id="cb40"><pre
        class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(route<span class="op">=</span><span class="st">&quot;mfa&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> mfa_endpoint(req):</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> mfa_workflow <span class="im">import</span> run_mfa_workflow  <span class="co"># INNERHALB der Funktion!</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="cf">await</span> run_mfa_workflow(...)</span></code></pre></div>
        <p><strong>5. host.json</strong></p>
        <div class="sourceCode" id="cb41"><pre
        class="sourceCode json"><code class="sourceCode json"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;2.0&quot;</span><span class="fu">,</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;functionTimeout&quot;</span><span class="fu">:</span> <span class="st">&quot;00:03:30&quot;</span><span class="fu">,</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;logging&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;applicationInsights&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;samplingSettings&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;isEnabled&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;excludedTypes&quot;</span><span class="fu">:</span> <span class="st">&quot;Request&quot;</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;logLevel&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;default&quot;</span><span class="fu">:</span> <span class="st">&quot;Information&quot;</span><span class="fu">,</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Host.Results&quot;</span><span class="fu">:</span> <span class="st">&quot;Error&quot;</span><span class="fu">,</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Function&quot;</span><span class="fu">:</span> <span class="st">&quot;Information&quot;</span><span class="fu">,</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;Host.Aggregator&quot;</span><span class="fu">:</span> <span class="st">&quot;Trace&quot;</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;extensionBundle&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;Microsoft.Azure.Functions.ExtensionBundle&quot;</span><span class="fu">,</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;[4.*, 5.0.0)&quot;</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
        <p><strong>6. App Settings konfigurieren</strong></p>
        <div class="sourceCode" id="cb42"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>az functionapp config appsettings <span class="fu">set</span> `</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>name contextpilot-mfa-func `</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>resource-group ContextPilot-Resource `</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>settings `</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;AZURE_AI_PROJECT_ENDPOINT=https://contextpilot-resource.services.ai.azure.com/api/projects/contextpilot&quot;</span> `</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;AZURE_AI_MODEL_DEPLOYMENT_NAME=gpt-4o&quot;</span> `</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;AURA_TRIAGE_AGENT_NAME=AURATriage&quot;</span> `</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;AURA_QUICK_AGENT_NAME=AURAContextPilotQuick&quot;</span> `</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;AURA_WEB_AGENT_NAME=AURAContextPilotWeb&quot;</span> `</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;AURA_CONTEXT_AGENT_NAME=AURAContextPilot&quot;</span> `</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;AURA_SYNTHESIZER_AGENT_NAME=AURAContextPilotResponseSynthesizer&quot;</span> `</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;AzureWebJobsFeatureFlags=EnableWorkerIndexing&quot;</span></span></code></pre></div>
        <p><strong>7. Deployment durchfÃ¼hren</strong></p>
        <div class="sourceCode" id="cb43"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> E<span class="op">:</span>\ContextPilot\contextpilot-mfa-function</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>func azure functionapp publish contextpilot-mfa-func <span class="op">--</span>python</span></code></pre></div>
        <p><strong>Erwartete Ausgabe bei Erfolg:</strong></p>
        <pre><code>Functions in contextpilot-mfa-func:
    healthz - [httpTrigger]
        Invoke url: https://contextpilot-mfa-func.azurewebsites.net/api/healthz

    mfa_endpoint - [httpTrigger]
        Invoke url: https://contextpilot-mfa-func.azurewebsites.net/api/mfa</code></pre>
        <p><strong>âš ï¸ Wenn â€œ0 Functionsâ€ angezeigt wird:</strong> PrÃ¼fe
        Application Insights auf ImportErrors (siehe
        Troubleshooting).</p>
        <hr />
        <h3 id="managed-identity-und-rbac">16.4 Managed Identity und
        RBAC</h3>
        <h4 id="executive-summary-3">16.4.1 Executive Summary</h4>
        <p>Die Azure Function muss auf Azure AI Foundry zugreifen
        kÃ¶nnen, um die Agents auszufÃ¼hren. Anstatt API-Keys im Code zu
        speichern, verwenden wir <strong>Managed Identity</strong> -
        Azure authentifiziert die Function automatisch. Die kritische
        Erkenntnis war, dass die RBAC-Rolle auf der <strong>richtigen
        Resource Group</strong> gesetzt werden muss (wo das AI Foundry
        Projekt liegt, nicht wo die Function liegt).</p>
        <h4 id="technische-details-2">16.4.2 Technische Details</h4>
        <p><strong>1. Managed Identity aktivieren</strong></p>
        <div class="sourceCode" id="cb45"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>az functionapp identity assign `</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>name contextpilot-mfa-func `</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>resource-group ContextPilot-Resource</span></code></pre></div>
        <p><strong>Ausgabe (Principal ID merken):</strong></p>
        <div class="sourceCode" id="cb46"><pre
        class="sourceCode json"><code class="sourceCode json"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;principalId&quot;</span><span class="fu">:</span> <span class="st">&quot;f6350cb3-3f75-414c-924f-c363a85aa072&quot;</span><span class="fu">,</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;tenantId&quot;</span><span class="fu">:</span> <span class="st">&quot;134528fb-1b3d-43bc-8b75-fb1361b41af1&quot;</span><span class="fu">,</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;SystemAssigned&quot;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
        <p><strong>2. RBAC-Rolle zuweisen</strong></p>
        <p>Die Function braucht die Rolle <strong>â€œAzure AI
        Userâ€</strong> auf der Resource Group, wo das AI Foundry Projekt
        liegt:</p>
        <div class="sourceCode" id="cb47"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WICHTIG: Rolle muss auf Area-Review-Resource gesetzt werden,</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># NICHT auf ContextPilot-Resource!</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>az role assignment create `</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>assignee f6350cb3-3f75-414c-924f-c363a85aa072 `</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>role <span class="st">&quot;Azure AI User&quot;</span> `</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>scope <span class="st">&quot;/subscriptions/&lt;SUBSCRIPTION_ID&gt;/resourceGroups/Area-Review-Resource&quot;</span></span></code></pre></div>
        <p><strong>Warum â€œAzure AI Userâ€?</strong></p>
        <p>Die Rolle enthÃ¤lt die notwendige Data Action fÃ¼r
        Agent-Zugriff:</p>
        <div class="sourceCode" id="cb48"><pre
        class="sourceCode json"><code class="sourceCode json"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;dataActions&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Microsoft.CognitiveServices/*&quot;</span><span class="ot">]</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
        <p>Andere Rollen wie â€œCognitive Services Userâ€ reichen NICHT fÃ¼r
        Agents!</p>
        <p><strong>3. Alle zugewiesenen Rollen prÃ¼fen</strong></p>
        <div class="sourceCode" id="cb49"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>az role assignment list `</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>assignee f6350cb3-3f75-414c-924f-c363a85aa072 `</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>scope <span class="st">&quot;/subscriptions/&lt;SUBSCRIPTION_ID&gt;/resourceGroups/Area-Review-Resource&quot;</span> `</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>query <span class="st">&quot;[].roleDefinitionName&quot;</span> <span class="op">-</span>o json</span></code></pre></div>
        <p><strong>Erwartete Ausgabe:</strong></p>
        <div class="sourceCode" id="cb50"><pre
        class="sourceCode json"><code class="sourceCode json"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span><span class="st">&quot;Azure AI User&quot;</span><span class="ot">]</span></span></code></pre></div>
        <p><strong>4. HÃ¤ufiger Fehler und LÃ¶sung</strong></p>
        <p><strong>Fehler:</strong></p>
        <pre><code>PermissionDenied: The principal lacks the required data action 
`Microsoft.CognitiveServices/accounts/AIServices/agents/read`</code></pre>
        <p><strong>Ursache:</strong> Rolle ist auf falscher Resource
        Group gesetzt.</p>
        <p><strong>LÃ¶sung:</strong> PrÃ¼fen wo das AI Foundry Projekt
        liegt:</p>
        <div class="sourceCode" id="cb52"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>az resource list <span class="op">--</span>query <span class="st">&quot;[?contains(name, &#39;contextpilot&#39;)].{name:name, rg:resourceGroup}&quot;</span> <span class="op">-</span>o table</span></code></pre></div>
        <hr />
        <h3 id="proxy-server-konfiguration">16.5 Proxy Server
        Konfiguration</h3>
        <h4 id="executive-summary-4">16.5.1 Executive Summary</h4>
        <p>Der Proxy Server ist der zentrale Routing-Punkt fÃ¼r alle
        Frontend-Anfragen. Er wurde erweitert, um den neuen MFA-Typ zu
        unterstÃ¼tzen. Die Konfiguration erfolgt Ã¼ber Umgebungsvariablen
        (<code>MFA_1_NAME</code>, <code>MFA_1_ENDPOINT</code>, etc.).
        Nach Ã„nderungen muss der Code via GitHub Actions neu deployed
        werden.</p>
        <h4 id="technische-details-3">16.5.2 Technische Details</h4>
        <p><strong>1. MFA-Umgebungsvariablen setzen</strong></p>
        <div class="sourceCode" id="cb53"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>az webapp config appsettings <span class="fu">set</span> `</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>name contextpilot-proxy-2025 `</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>resource-group ContextPilot-Resource `</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>settings `</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;MFA_1_NAME=MFA&quot;</span> `</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;MFA_1_LABEL=MFA (Multi-Agent)&quot;</span> `</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;MFA_1_ENDPOINT=https://contextpilot-mfa-func.azurewebsites.net/api/mfa&quot;</span></span></code></pre></div>
        <p><strong>âš ï¸ WICHTIG:</strong> Der Index startet bei 1, nicht
        bei 0! (<code>MFA_1_NAME</code>, nicht
        <code>MFA_0_NAME</code>)</p>
        <p><strong>2. Proxy Server Code (proxy-server.js)</strong></p>
        <p>Der Proxy lÃ¤dt MFA-Konfigurationen beim Start:</p>
        <div class="sourceCode" id="cb54"><pre
        class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">// MFA configs (Azure Function-backed MAF orchestration)</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">loadMFAConfigs</span>() {</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mfas <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_NAME`</span>]) {</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mfaId <span class="op">=</span> <span class="op">-</span><span class="dv">100</span> <span class="op">-</span> i<span class="op">;</span>  <span class="co">// Negative IDs ab -101 fÃ¼r MFA</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    mfas[mfaId] <span class="op">=</span> {</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">id</span><span class="op">:</span> mfaId<span class="op">,</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_NAME`</span>]<span class="op">,</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_LABEL`</span>] <span class="op">||</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_NAME`</span>]<span class="op">,</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">endpoint</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span>[<span class="vs">`MFA_</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">_ENDPOINT`</span>]<span class="op">,</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&quot;mfa&quot;</span><span class="op">,</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    i<span class="op">++;</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mfas<span class="op">;</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> MFAS <span class="op">=</span> <span class="fu">loadMFAConfigs</span>()<span class="op">;</span></span></code></pre></div>
        <p><strong>3. API Response mit MFA</strong></p>
        <p>Der <code>/agents</code> Endpoint gibt jetzt auch MFA
        zurÃ¼ck:</p>
        <div class="sourceCode" id="cb55"><pre
        class="sourceCode json"><code class="sourceCode json"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;agents&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;workflows&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;mfas&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">-101</span><span class="fu">,</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;MFA&quot;</span><span class="fu">,</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;MFA (Multi-Agent)&quot;</span><span class="fu">,</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;mfa&quot;</span><span class="fu">,</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;active&quot;</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;currentAgentId&quot;</span><span class="fu">:</span> <span class="dv">-1</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
        <hr />
        <h3 id="cicd-pipeline-github-actions">16.6 CI/CD Pipeline
        (GitHub Actions)</h3>
        <h4 id="executive-summary-5">16.6.1 Executive Summary</h4>
        <p>Beide Haupt-Komponenten (Proxy Server und Static Web App)
        werden automatisch deployed, wenn Code auf den <code>main</code>
        Branch gepusht wird. Die Function App wird hingegen manuell via
        <code>func azure functionapp publish</code> deployed.</p>
        <h4 id="technische-details-4">16.6.2 Technische Details</h4>
        <p><strong>1. Automatische Deployments (main
        Branch)</strong></p>
        <table>
        <colgroup>
        <col style="width: 32%" />
        <col style="width: 43%" />
        <col style="width: 24%" />
        </colgroup>
        <thead>
        <tr>
        <th>Komponente</th>
        <th>Workflow-Datei</th>
        <th>Trigger</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td>Proxy Server</td>
        <td><code>.github/workflows/main_contextpilot-proxy-2025.yml</code></td>
        <td>Push to <code>main</code></td>
        </tr>
        <tr>
        <td>Static Web App</td>
        <td><code>.github/workflows/azure-static-web-apps-ashy-dune-06d0e9810.yml</code></td>
        <td>Push to <code>main</code></td>
        </tr>
        <tr>
        <td>Function App</td>
        <td>(kein Workflow)</td>
        <td>Manuell: <code>func azure functionapp publish</code></td>
        </tr>
        </tbody>
        </table>
        <p><strong>2. Workflow fÃ¼r Proxy Server</strong></p>
        <div class="sourceCode" id="cb56"><pre
        class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and deploy Node.js app to Azure Web App - contextpilot-proxy-2025</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> main</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">workflow_dispatch</span><span class="kw">:</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Node.js version</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-node@v3</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">node-version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;22.x&#39;</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> npm install, build, and test</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">working-directory</span><span class="kw">:</span><span class="at"> live-transcriber</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>          npm install</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>          npm run build --if-present</span></code></pre></div>
        <p><strong>3. Deployment-Workflow</strong></p>
        <pre><code>1. Entwicklung auf Feature-Branch (z.B. `maf`)
2. Commit &amp; Push zu Feature-Branch
3. Lokaler Test
4. Merge zu `main`: git checkout main &amp;&amp; git merge maf &amp;&amp; git push origin main
5. GitHub Actions triggert automatisch
6. Deployment lÃ¤uft (ca. 2-3 Minuten)
7. Verifizieren: https://contextpilot-proxy-2025-*.azurewebsites.net/agents</code></pre>
        <p><strong>4. Function App manuell deployen</strong></p>
        <div class="sourceCode" id="cb58"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> E<span class="op">:</span>\ContextPilot\contextpilot-mfa-function</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>func azure functionapp publish contextpilot-mfa-func <span class="op">--</span>python</span></code></pre></div>
        <hr />
        <h3 id="troubleshooting-1">16.7 Troubleshooting</h3>
        <h4 id="problem-0-functions-nach-deployment">16.7.1 Problem: â€œ0
        Functionsâ€ nach Deployment</h4>
        <p><strong>Symptom:</strong></p>
        <pre><code>Functions in contextpilot-mfa-func:
    (leer)</code></pre>
        <p><strong>Ursache:</strong> ImportError beim Laden von
        <code>function_app.py</code></p>
        <p><strong>Diagnose via Application Insights:</strong></p>
        <div class="sourceCode" id="cb60"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># App Insights App-ID holen</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="va">$aiAppId</span> <span class="op">=</span> az monitor app-insights component show `</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>g ContextPilot-Resource <span class="op">-</span>a contextpilot-mfa-func `</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>query appId <span class="op">-</span>o tsv</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Exceptions abfragen</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>az monitor app-insights query <span class="op">--</span>app <span class="va">$aiAppId</span> <span class="op">--</span>analytics-query `</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;exceptions | where timestamp &gt; ago(1h) | project timestamp, outerMessage | take 5&quot;</span></span></code></pre></div>
        <p><strong>Typische Fehler:</strong> -
        <code>ModuleNotFoundError: agent-framework-azure-ai</code> â†’
        Package in requirements.txt hinzufÃ¼gen -
        <code>ModuleNotFoundError: mfa_workflow</code> â†’ Datei fehlt im
        Deployment-Package</p>
        <p><strong>LÃ¶sung:</strong> Lazy Import verwenden (siehe 16.3.2
        Punkt 4)</p>
        <h4 id="problem-permissiondenied-bei-agent-zugriff">16.7.2
        Problem: PermissionDenied bei Agent-Zugriff</h4>
        <p><strong>Symptom:</strong></p>
        <div class="sourceCode" id="cb61"><pre
        class="sourceCode json"><code class="sourceCode json"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="st">&quot;The principal lacks the required data action </span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="st">            Microsoft.CognitiveServices/accounts/AIServices/agents/read&quot;</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
        <p><strong>Diagnose:</strong></p>
        <div class="sourceCode" id="cb62"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PrÃ¼fe wo das AI Foundry Projekt liegt</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>az resource list <span class="op">--</span>query <span class="st">&quot;[?contains(name, &#39;contextpilot&#39;)].resourceGroup&quot;</span> <span class="op">-</span>o table</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co"># PrÃ¼fe zugewiesene Rollen</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>az role assignment list <span class="op">--</span>assignee <span class="op">&lt;</span>PRINCIPAL_ID<span class="op">&gt;</span> <span class="op">-</span>o table</span></code></pre></div>
        <p><strong>LÃ¶sung:</strong> â€œAzure AI Userâ€ Rolle auf die
        korrekte Resource Group setzen.</p>
        <h4 id="problem-mfa-erscheint-nicht-im-frontend">16.7.3 Problem:
        MFA erscheint nicht im Frontend</h4>
        <p><strong>Symptom:</strong> Dropdown zeigt nur â€œAgentâ€ und
        â€œWorkflowâ€, kein â€œMFAâ€</p>
        <p><strong>Diagnose:</strong></p>
        <div class="sourceCode" id="cb63"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PrÃ¼fe ob MFA-Config gesetzt ist</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>az webapp config appsettings list `</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>name contextpilot-proxy-2025 `</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>resource-group ContextPilot-Resource `</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>query <span class="st">&quot;[?contains(name, &#39;MFA&#39;)]&quot;</span> <span class="op">-</span>o table</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co"># PrÃ¼fe API Response</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="fu">Invoke-RestMethod</span> <span class="op">-</span>Uri <span class="st">&quot;https://&lt;PROXY_URL&gt;/agents&quot;</span> <span class="op">|</span> <span class="fu">ConvertTo-Json</span></span></code></pre></div>
        <p><strong>MÃ¶gliche Ursachen:</strong> 1. MFA-Umgebungsvariablen
        fehlen â†’ setzen mit
        <code>az webapp config appsettings set</code> 2. Falscher Index
        (<code>MFA_0_</code> statt <code>MFA_1_</code>) â†’ Index muss bei
        1 starten 3. Alter Code deployed â†’ Push zu <code>main</code> und
        warten auf GitHub Actions</p>
        <hr />
        <h3 id="verifizierung">16.8 Verifizierung</h3>
        <p>Nach erfolgreichem Deployment sollten alle Tests
        bestehen:</p>
        <div class="sourceCode" id="cb64"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Health Check</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Invoke-RestMethod</span> <span class="op">-</span>Uri <span class="st">&quot;https://contextpilot-mfa-func.azurewebsites.net/api/healthz&quot;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Erwartung: {&quot;ok&quot;: true, &quot;version&quot;: &quot;2.4&quot;}</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. MFA Endpoint Test</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="va">$body</span> <span class="op">=</span> <span class="st">&#39;{&quot;prompt&quot;: &quot;What is 2+2?&quot;}&#39;</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Invoke-RestMethod</span> <span class="op">-</span>Uri <span class="st">&quot;https://contextpilot-mfa-func.azurewebsites.net/api/mfa&quot;</span> `</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>Method POST <span class="op">-</span>Body <span class="va">$body</span> <span class="op">-</span>ContentType <span class="st">&quot;application/json&quot;</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Erwartung: {&quot;output_text&quot;: &quot;4&quot;, &quot;workflow&quot;: &quot;mfa&quot;, &quot;agents_used&quot;: [...]}</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Proxy Server MFA-Liste</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="fu">Invoke-RestMethod</span> <span class="op">-</span>Uri <span class="st">&quot;https://&lt;PROXY_URL&gt;/agents&quot;</span> <span class="op">|</span> <span class="fu">ConvertTo-Json</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Erwartung: Response enthÃ¤lt &quot;mfas&quot; Array</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Frontend</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Ã–ffne https://ashy-dune-06d0e9810.4.azurestaticapps.net/</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Erwartung: &quot;MFA (Multi-Agent)&quot; erscheint im Dropdown</span></span></code></pre></div>
        <hr />
        <h3 id="quick-reference">16.9 Quick Reference</h3>
        <p><strong>Wichtige URLs:</strong></p>
        <table>
        <colgroup>
        <col style="width: 70%" />
        <col style="width: 29%" />
        </colgroup>
        <thead>
        <tr>
        <th>Komponente</th>
        <th>URL</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td>Function App Health</td>
        <td><code>https://contextpilot-mfa-func.azurewebsites.net/api/healthz</code></td>
        </tr>
        <tr>
        <td>Function App MFA</td>
        <td><code>https://contextpilot-mfa-func.azurewebsites.net/api/mfa</code></td>
        </tr>
        <tr>
        <td>Proxy Server Agents</td>
        <td><code>https://contextpilot-proxy-2025-*.azurewebsites.net/agents</code></td>
        </tr>
        <tr>
        <td>Frontend</td>
        <td><code>https://ashy-dune-06d0e9810.4.azurestaticapps.net/</code></td>
        </tr>
        <tr>
        <td>GitHub Actions</td>
        <td><code>https://github.com/JohnMavic/ContextPilot/actions</code></td>
        </tr>
        </tbody>
        </table>
        <p><strong>Wichtige Befehle:</strong></p>
        <div class="sourceCode" id="cb65"><pre
        class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function App deployen</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> E<span class="op">:</span>\ContextPilot\contextpilot-mfa-function</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>func azure functionapp publish contextpilot-mfa-func <span class="op">--</span>python</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Proxy Server deployen (via Git)</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>git checkout main</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>git merge <span class="op">&lt;</span>feature-branch<span class="op">&gt;</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>git push origin main</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Function App Logs</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>az monitor app-insights query <span class="op">--</span>app <span class="op">&lt;</span>APP_ID<span class="op">&gt;</span> <span class="op">--</span>analytics-query <span class="st">&quot;exceptions | take 10&quot;</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Function App neustarten</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>az functionapp restart <span class="op">--</span>name contextpilot-mfa-func <span class="op">--</span>resource-group ContextPilot-Resource</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Proxy Server neustarten</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>az webapp restart <span class="op">--</span>name contextpilot-proxy-2025 <span class="op">--</span>resource-group ContextPilot-Resource</span></code></pre></div>
      </div>
    </div>
  </div>
  
  <script>
    const resizer = document.getElementById('resizer');
    const sidebar = document.querySelector('.sidebar');
    let isResizing = false;
    
    resizer.addEventListener('mousedown', () => {
      isResizing = true;
      resizer.classList.add('active');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });
    
    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      if (e.clientX >= 200 && e.clientX <= 500) {
        sidebar.style.width = e.clientX + 'px';
      }
    });
    
    document.addEventListener('mouseup', () => {
      isResizing = false;
      resizer.classList.remove('active');
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    });
  </script>
</body>
</html>
